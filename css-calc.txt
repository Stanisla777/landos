// –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ DOM
document.addEventListener('DOMContentLoaded', function () {
  // –ú–æ–∂–Ω–æ –∑–∞–¥–µ—Ä–∂–∞—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
  setTimeout(() => {
    document.addEventListener('click', function (e) {
      const buttonSelector = '.js--btn-registration-state';
      const btn = document.querySelector(buttonSelector);
      if (!btn || !e.target.closest(buttonSelector)) return;

      e.preventDefault();
      console.log('‚úÖ –ö–ª–∏–∫ –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω –Ω–∞ —Ñ–∞–∑–µ CAPTURE');

      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å
      const container = btn.closest('.feed_back__wr-checkbox') || btn.closest('form') || document;
      const checkboxWrappers = container.querySelectorAll('.js--checkbox_wrapper');
      const errorClass = 'js--input__error_required';

      let hasError = false;

      // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ—à–∏–±–∫–∏
      checkboxWrappers.forEach(wrapper => {
        const formBlock = wrapper.querySelector('.feed_back__user-form-block');
        if (formBlock) {
          const error = formBlock.querySelector('.' + errorClass);
          if (error) error.remove();
        }
      });

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ–∫–±–æ–∫—Å—ã
      checkboxWrappers.forEach(wrapper => {
        const checkbox = wrapper.querySelector('input[type="checkbox"]');
        const formBlock = wrapper.querySelector('.feed_back__user-form-block');

        if (!checkbox || !formBlock) return;

        if (checkbox.hasAttribute('required') && !checkbox.checked) {
          const message = checkbox.getAttribute('data-required-hint') || '–°–æ–≥–ª–∞—Å–∏—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏';
          const error = document.createElement('p');
          error.className = 'input__error ' + errorClass;
          error.textContent = message;
          formBlock.appendChild(error);
          hasError = true;
        }
      });

      if (hasError) {
        console.log('‚ùå –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞');
        return;
      }

      // –í—ã–ø–æ–ª–Ω—è–µ–º onclick
      const onclickAttr = btn.getAttribute('onclick');
      if (onclickAttr) {
        try {
          new Function(onclickAttr)();
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è onclick:', err);
        }
      }
    }, true); // <-- useCapture = true

    console.log('üîê –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ —Ñ–∞–∑–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞');
  }, 100);
});
