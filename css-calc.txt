// Общая функция для вертикального позиционирования тултипа
function positionTooltipVertically(rect, tooltip, offset = 4) {
  const viewportHeight = window.innerHeight;
  const topOffset = rect.top + rect.height / 2;

  if (viewportHeight / 2 < topOffset) {
    // Иконка ниже середины экрана → тултип сверху
    tooltip.style.top = 'auto';
    tooltip.style.bottom = `${viewportHeight - rect.top + offset}px`;
    tooltip.classList.add('up');
    tooltip.classList.remove('down');
  } else {
    // Иконка выше середины экрана → тултип снизу
    tooltip.style.top = `${rect.bottom - offset}px`;
    tooltip.style.bottom = 'auto';
    tooltip.classList.add('down');
    tooltip.classList.remove('up');
  }
}

-------------------------------------------------------

// Позиционирование тултипа относительно экрана
function positionTooltip(trigger, tooltip) {
  const rect = trigger.getBoundingClientRect();
  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;

  const isMobileOrTablet = isMobileDevice();
  const isNarrow = window.matchMedia('(max-width: 480px)').matches;

  // Для мобильных устройств использую мобильный вид
  if (isMobileOrTablet || isNarrow) {
    tooltip.style.transform = 'translate(-50%, -50%)';
    tooltip.classList.add('mobile-tooltip');
    return;
  }

  // Сбрасываю позиционирование
  tooltip.style.left = '';
  tooltip.style.right = '';
  tooltip.style.top = '';
  tooltip.style.bottom = '';
  tooltip.style.transform = '';

  // Измеряю размеры тултипа
  const originalDisplay = tooltip.style.display;
  tooltip.style.display = 'block';
  tooltip.style.opacity = '0';
  const tooltipRect = tooltip.getBoundingClientRect();
  const tooltipWidth = tooltipRect.width;
  const tooltipHeight = tooltipRect.height;
  tooltip.style.display = originalDisplay;
  tooltip.style.opacity = '';

  // Определяю позиционирование для короткого текста
  if (tooltip.classList.contains('location-side')) {
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    const offset = 10; // отступ от иконки

    // Основное позиционирование - зависит от положения иконки относительно середины экрана
    if (viewportWidth / 2 < centerX) {
      // Иконка правее середины → тултип слева от иконки
      // Проверяем, что тултип не вылезает за левый край
      if (rect.left - tooltipWidth - offset >= 0) {
        // Помещается слева → показываем слева
        tooltip.style.right = `${viewportWidth - rect.left + (offset - 15)}px`;
        tooltip.classList.add('left');
        tooltip.classList.remove('right');
      } else {
        // Не помещается слева → показываем справа
        tooltip.style.left = `${rect.right + offset}px`;
        tooltip.classList.add('right');
        tooltip.classList.remove('left');
      }
    } else {
      // Иконка левее середины → тултип справа от иконки
      // Проверяем, что тултип не вылезает за правый край
      if (rect.right + tooltipWidth + offset <= viewportWidth) {
        // Помещается справа → показываем справа
        tooltip.style.left = `${rect.right + offset}px`;
        tooltip.classList.add('right');
        tooltip.classList.remove('left');
      } else {
        // Не помещается справа → показываем слева
        tooltip.style.right = `${viewportWidth - rect.left + offset}px`;
        tooltip.classList.add('left');
        tooltip.classList.remove('right');
      }
    }

    // Вертикальное позиционирование (по центру иконки)
    tooltip.style.top = `${centerY - tooltipHeight / 2}px`;
    tooltip.classList.remove('up', 'down');

    return;
  }

  // Для длинного текста использую стандартное позиционирование

  // Горизонтальное позиционирование
  // Если центр иконки правее середины экрана → тултип слева от иконки
  // Если центр иконки левее середины экрана → тултип справа от иконки
  const leftOffset = rect.left + rect.width / 2;
  const offset = 4; // отступ от иконки

  if (viewportWidth / 2 < leftOffset) {
    // Иконка правее середины → тултип слева от иконки - прижимаем к ПРАВОМУ краю иконки
    tooltip.style.left = 'auto';
    tooltip.style.right = `${viewportWidth - rect.right + (offset - 21)}px`;
    tooltip.classList.add('left');
    tooltip.classList.remove('right');
  } else {
    // Иконка левее середины → тултип справа от иконки - прижимаем к ЛЕВОМУ краю иконки
    tooltip.style.left = `${rect.left - offset}px`;
    tooltip.style.right = 'auto';
    tooltip.classList.add('right');
    tooltip.classList.remove('left');
  }

  // Вертикальное позиционирование - используем общую функцию
  positionTooltipVertically(rect, tooltip, offset);
}

----------------------------------------------------------------------------

// Позиционирование тултипа относительно родителя с классом .js--focus-on-parent
function positionTooltipRelativeToParent(trigger, tooltip) {
  const rect = trigger.getBoundingClientRect();
  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;

  const isMobileOrTablet = isMobileDevice();
  const isNarrow = window.matchMedia('(max-width: 480px)').matches;

  // Для мобильных устройств использую мобильный вид
  if (isMobileOrTablet || isNarrow) {
    tooltip.style.transform = 'translate(-50%, -50%)';
    tooltip.classList.add('mobile-tooltip');
    return;
  }

  // Сбрасываю позиционирование
  tooltip.style.left = '';
  tooltip.style.right = '';
  tooltip.style.top = '';
  tooltip.style.bottom = '';
  tooltip.style.transform = '';

  // Измеряю размеры тултипа
  const originalDisplay = tooltip.style.display;
  tooltip.style.display = 'block';
  tooltip.style.opacity = '0';
  const tooltipRect = tooltip.getBoundingClientRect();
  const tooltipWidth = tooltipRect.width;
  const tooltipHeight = tooltipRect.height;
  tooltip.style.display = originalDisplay;
  tooltip.style.opacity = '';

  // Находим родителя с классом .js--focus-on-parent
  const focusParent = trigger.closest('.js--focus-on-parent');
  if (!focusParent) {
    // Если родителя нет, используем обычное позиционирование
    positionTooltip(trigger, tooltip);
    return;
  }

  const parentRect = focusParent.getBoundingClientRect();

  // Определяю позиционирование для короткого текста
  if (tooltip.classList.contains('location-side')) {
    const iconCenterInParent = rect.left - parentRect.left + rect.width / 2;
    const parentCenter = parentRect.width / 2;
    const centerY = rect.top + rect.height / 2;
    const offset = 10;

    // Горизонтальное позиционирование
    if (iconCenterInParent > parentCenter) {
      // Иконка правее середины родителя → тултип слева от иконки
      // Проверяем, что тултип не выходит за левую границу родителя
      if (rect.left - tooltipWidth - offset >= parentRect.left) {
        tooltip.style.right = `${viewportWidth - rect.left + offset}px`;
        tooltip.classList.add('left');
        tooltip.classList.remove('right');
      } else {
        // Не помещается слева → показываем справа
        tooltip.style.left = `${rect.right + offset}px`;
        tooltip.classList.add('right');
        tooltip.classList.remove('left');
      }
    } else {
      // Иконка левее середины родителя → тултип справа от иконки
      // Проверяем, что тултип не выходит за правую границу родителя
      if (rect.right + tooltipWidth + offset <= parentRect.right) {
        tooltip.style.left = `${rect.right + offset}px`;
        tooltip.classList.add('right');
        tooltip.classList.remove('left');
      } else {
        // Не помещается справа → показываем слева
        tooltip.style.right = `${viewportWidth - rect.left + offset}px`;
        tooltip.classList.add('left');
        tooltip.classList.remove('right');
      }
    }

    // Вертикальное позиционирование (по центру иконки)
    tooltip.style.top = `${centerY - tooltipHeight / 2}px`;
    tooltip.classList.remove('up', 'down');

    return;
  }

  // Для длинного текста используем стандартное позиционирование

  // Горизонтальное позиционирование (относительно родителя)
  const iconCenterInParent = rect.left - parentRect.left + rect.width / 2;
  const parentCenter = parentRect.width / 2;
  const offset = 4;

  if (iconCenterInParent > parentCenter) {
    // Иконка правее середины родителя → тултип слева от иконки
    // Проверяем, что тултип не выходит за левую границу родителя
    if (rect.left - tooltipWidth - offset >= parentRect.left) {
      tooltip.style.left = 'auto';
      tooltip.style.right = `${viewportWidth - rect.right + offset}px`;
      tooltip.classList.add('left');
      tooltip.classList.remove('right');
    } else {
      // Не помещается слева → показываем справа
      tooltip.style.left = `${rect.left - offset}px`;
      tooltip.style.right = 'auto';
      tooltip.classList.add('right');
      tooltip.classList.remove('left');
    }
  } else {
    // Иконка левее середины родителя → тултип справа от иконки
    // Проверяем, что тултип не выходит за правую границу родителя
    if (rect.right + tooltipWidth + offset <= parentRect.right) {
      tooltip.style.left = `${rect.left - offset}px`;
      tooltip.style.right = 'auto';
      tooltip.classList.add('right');
      tooltip.classList.remove('left');
    } else {
      // Не помещается справа → показываем слева
      tooltip.style.left = 'auto';
      tooltip.style.right = `${viewportWidth - rect.right + offset}px`;
      tooltip.classList.add('left');
      tooltip.classList.remove('right');
    }
  }

  // Вертикальное позиционирование - используем общую функцию
  positionTooltipVertically(rect, tooltip, offset);
}
