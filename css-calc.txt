/* eslint-disable */
export default function contentNote() {
  const notes = document.querySelectorAll('.js--content-note');

  const isTouchDevice = () => {
    return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  };

  const isIOS = () => {
    return /(iPad|iPhone|iPod)/.test(navigator.userAgent) && !window.MSStream;
  };

  const positionTooltip = (element) => {
    const noteText = element.querySelector('.content-note__text');
    const computed = getComputedStyle(noteText);

    // === ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼: ÐµÑÐ»Ð¸ transform, left, top, right, bottom ÑƒÐ¶Ðµ Ð·Ð°Ð´Ð°Ð½Ñ‹ â€” Ð½Ðµ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ ===
    const hasTransform = computed.transform && computed.transform !== 'none';
    const hasLeft = computed.left !== 'auto';
    const hasRight = computed.right !== 'auto';
    const hasTop = computed.top !== 'auto';
    const hasBottom = computed.bottom !== 'auto';

    if (hasTransform || hasLeft || hasRight || hasTop || hasBottom) {
      return; // Ð£Ð¶Ðµ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¾Ð½Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ â€” Ð½Ðµ Ñ‚Ñ€Ð¾Ð³Ð°ÐµÐ¼
    }

    // === âœ… ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ===
    const rect = element.getBoundingClientRect();
    const parent = element.parentElement;
    const parentPos = parent.getBoundingClientRect();
    const relativePosLeftElement = rect.left - parentPos.left;
    const windowWidth = window.innerWidth;
    const windowHeight = window.innerHeight;
    const parentWidth = parent.offsetWidth;
    const leftOffset = rect.left + rect.width / 2;
    const topOffset = rect.top + rect.height / 2;

    // Ð¡Ð±Ñ€Ð¾ÑÐ¸Ð¼ transform Ð´Ð»Ñ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ð³Ð¾ Ð¸Ð·Ð¼ÐµÑ€ÐµÐ½Ð¸Ñ ÑˆÐ¸Ñ€Ð¸Ð½Ñ‹
    const originalTransform = noteText.style.transform;
    noteText.style.transform = 'none';
    const tooltipWidth = noteText.offsetWidth;
    noteText.style.transform = originalTransform;

    // ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ñ… ÑÑ‚Ð¸Ð»ÐµÐ¹
    noteText.style.left = '';
    noteText.style.right = '';
    noteText.style.top = '';
    noteText.style.bottom = '';
    noteText.style.inset = '';
    noteText.style.transform = '';

    // === Ð“Ð¾Ñ€Ð¸Ð·Ð¾Ð½Ñ‚Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ===
    const hasSpecialParent = element.closest('.js--courses-accord-content') ||
      element.closest('.js--element-overflow');

    if (hasSpecialParent) {
      if (windowWidth >= 600) {
        if (parentWidth / 2 < relativePosLeftElement) {
          noteText.style.left = 'auto';
          noteText.style.right = '-.25rem';
        } else {
          noteText.style.left = '.25rem';
          noteText.style.right = 'auto';
        }
      } else {
        noteText.style.inset = 'unset';
        noteText.style.transform = `translateX(${-((rect.left - tooltipWidth / 2 + 7) - (windowWidth / 2 - tooltipWidth / 2))}px)`;
      }
    } else {
      if (windowWidth >= 600) {
        if (windowWidth / 2 < leftOffset) {
          noteText.style.left = 'auto';
          noteText.style.right = '-.25rem';
        } else {
          noteText.style.left = '.25rem';
          noteText.style.right = 'auto';
        }
      } else {
        noteText.style.inset = 'unset';
        noteText.style.transform = `translateX(${-((rect.left - tooltipWidth / 2 + 7) - (windowWidth / 2 - tooltipWidth / 2))}px)`;
      }
    }

    // === Ð’ÐµÑ€Ñ‚Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ===
    let notesParentBounding = null;
    const coursesAccord = element.closest('.js--courses-accord-content');
    if (coursesAccord) {
      notesParentBounding = coursesAccord.getBoundingClientRect();
    }

    if (notesParentBounding) {
      const locationDifference = rect.top - notesParentBounding.top;
      const heightTooltip = noteText.offsetHeight;

      if (heightTooltip >= locationDifference) {
        noteText.style.top = 'calc(100% + .25rem)';
        noteText.style.bottom = 'auto';
      } else if (heightTooltip < locationDifference && windowHeight / 2 < topOffset) {
        noteText.style.top = 'auto';
        noteText.style.bottom = 'calc(100% + .25rem)';
      } else {
        noteText.style.top = 'calc(100% + .25rem)';
        noteText.style.bottom = 'auto';
      }
    } else {
      // ÐžÐ±Ñ‹Ñ‡Ð½Ð¾Ðµ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ (Ð½Ðµ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°)
      if (windowHeight / 2 > topOffset) {
        noteText.style.top = 'calc(100% + .25rem)';
        noteText.style.bottom = 'auto';
      } else {
        noteText.style.top = 'auto';
        noteText.style.bottom = 'calc(100% + .25rem)';
      }
    }
  };

  if (isTouchDevice() || isIOS()) {
    document.addEventListener('touchstart', (e) => {
      const isNote = e.target.classList.contains('js--content-note')
      
      // ÐœÐ˜ÐÐ˜ÐœÐÐ›Ð¬ÐÐžÐ• Ð˜Ð—ÐœÐ•ÐÐ•ÐÐ˜Ð•: Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð¿Ñ€Ð¸ ÐºÐ»Ð¸ÐºÐµ Ð½Ð° ÑƒÐ¶Ðµ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ñ‹Ð¹ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚
      if (isNote && e.target.classList.contains('active')) {
        notes.forEach(item => {
          item.classList.remove('active');
          const text = item.querySelector('.content-note__text');
          text.classList.remove('active');
          text.classList.remove('up');
          text.classList.remove('down');
        });
        return;
      }

      if (isNote) {
        notes.forEach(item => {
          item.classList.remove('active');
          const text = item.querySelector('.content-note__text');
          text.classList.remove('active');
          text.classList.remove('up');
          text.classList.remove('down');
        });

        const noteText = e.target.querySelector('.content-note__text');
        const rect = e.target.getBoundingClientRect();
        const windowHeight = window.innerHeight;
        const topOffset = rect.top + rect.height / 2;

        //  Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ (up/down) Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ»Ð°ÑÑÑ‹ ===
        if (windowHeight / 2 > topOffset) {
          noteText.classList.add('down');
          noteText.classList.remove('up');
        } else {
          noteText.classList.add('up');
          noteText.classList.remove('down');
        }

        //  Ð¡ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð²Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ð¾, Ð½Ð¾ Ð´ÐµÐ»Ð°ÐµÐ¼ Ð¸Ð·Ð¼ÐµÑ€Ð¸Ð¼Ñ‹Ð¼ ===
        noteText.style.visibility = 'hidden';
        noteText.style.opacity = '0';
        noteText.style.transition = 'none';

        //  ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚ (Ð½Ð¾ Ð½ÐµÐ²Ð¸Ð´Ð¸Ð¼Ð¾) ===
        e.target.classList.add('active');
        noteText.classList.add('active');

        //  ÐŸÐ¾Ð·Ð¸Ñ†Ð¸Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ â€” Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ð·Ð½Ð°ÐµÑ‚, Ñ‡Ñ‚Ð¾ ÐºÐ»Ð°ÑÑ up/down ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ ===
        positionTooltip(e.target);

        //  ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ñ Ð°Ð½Ð¸Ð¼Ð°Ñ†Ð¸ÐµÐ¹ ===
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            noteText.style.visibility = 'visible';
            noteText.style.opacity = '1';
            noteText.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
          });
        });
      }
    });

    // Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð¿Ñ€Ð¸ ÐºÐ»Ð¸ÐºÐµ Ð¼Ð¸Ð¼Ð¾
    document.addEventListener('click', (e) => {
      if (!e.target.classList.contains('js--content-note') &&
        !e.target.closest('.content-note__text')) {
        notes.forEach(item => {
          item.classList.remove('active');
          item.querySelector('.content-note__text').classList.remove('active');
        });
      }
    });
  }

  document.addEventListener('mouseover', (e) => {
    if (e.target.classList.contains('js--content-note')) {
      if (e.target.querySelector('.content-note__text')) {
        e.target.querySelector('.content-note__text').classList.add('active');
      }

      e.target.classList.add('active');
      const rect = e.target.getBoundingClientRect();
      const parent = e.target.parentElement;
      // eslint-disable-next-line no-unused-vars
      const tooltip = e.target.querySelector('.content-note__text');
      const parentPos = parent.getBoundingClientRect();
      const relativePosLeftElement = rect.left - parentPos.left;
      const noteText = e.target.querySelector('.content-note__text');
      // eslint-disable-next-line no-unused-vars
      const windowWidth = document.body.offsetWidth;
      // eslint-disable-next-line no-unused-vars
      const windowHeight = window.innerHeight;
      const parentWidth = parent.offsetWidth;
      // ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹ Ð¾Ñ‚ Ñ†ÐµÐ½Ñ‚Ñ€Ð° ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð°
      // eslint-disable-next-line no-unused-vars
      const leftOffset = rect.left + rect.width / 2;
      const rightOffset = rect.right + rect.width / 2;
      // eslint-disable-next-line no-unused-vars
      const topOffset = rect.top + rect.height / 2;

      // ÐµÑÐ»Ð¸ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚ Ð±Ð»Ð¸Ð¶Ðµ Ðº Ð»ÐµÐ²Ð¾Ð¼Ñƒ ÐºÑ€Ð°ÑŽ ÑÐºÑ€Ð°Ð½Ð° - Ð²Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ Ð¿Ð¾Ð´ÑÐºÐ°Ð·ÐºÑƒ ÑÐ¿Ñ€Ð°Ð²Ð° Ð¾Ñ‚ Ð½ÐµÐ³Ð¾
      // Ð¸Ð½Ð°Ñ‡Ðµ ÑÐ»ÐµÐ²Ð°
      // eslint-disable-next-line max-len
      // Ñ‚ÑƒÑ‚ ÑÑ‚Ð¾Ð¸Ñ‚ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ Ð¿Ð¾ Ð±Ð»Ð¾ÐºÐ°Ð¼, Ð² ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð¼ ÐµÑÑ‚ÑŒ Ñ‚ÑƒÐ»Ñ‚Ð¸Ð¿, ÐµÑÐ»Ð¸ Ñƒ Ñ€Ð¾Ð´Ð¸Ñ‚ÐµÐ»Ñ ÐµÑÑ‚ÑŒ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾
      // eslint-disable-next-line max-len
      // ÑˆÐ¸Ñ€Ð¸Ð½Ðµ Ð¸ Ð¾Ð½Ð¾ Ð¸Ð¼ÐµÐµÑ‚ ovrflow:hidden Ñ‚Ð¾ Ñ€Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŽ Ð½ÑƒÐ¶Ð½Ð¾ Ð¿Ð¾Ñ€Ð¾Ð¿Ð¸ÑÐ°Ñ‚ÑŒ ÐºÐ»Ð°ÑÑ .js--element-overflow
      // eslint-disable-next-line camelcase
      if (e.target.closest('.js--courses-accord-content') || e.target.closest('.js--element-overflow') || e.target.closest('.js--element-overflow-x')) {


        // if (windowWidth >= 600) {
          if (parentWidth / 2 < relativePosLeftElement) {
            noteText.style.left = 'auto';
            noteText.style.right = '-.25rem';
          } else {
            noteText.style.left = '.25rem';
            noteText.style.right = 'auto';
          }
        // }
        if (windowWidth < 470) {
          noteText.style.left = 0
          noteText.style.transform = `translateX(${(-(leftOffset - 28)) + ((windowWidth / 2) - 40) - ((tooltip.offsetWidth / 2) - 15) }px)`;
        }

      } else {

        if (windowWidth / 2 < leftOffset) {
          // ÐºÐ¾Ð³Ð´Ð° Ð¸ÐºÐ¾Ð½ÐºÐ° Ð±Ð»Ð¸Ð¶Ðµ Ðº Ð¿Ñ€Ð°Ð²Ð¾Ð¼Ñƒ ÐºÑ€Ð°ÑŽ
          if (tooltip.offsetWidth > leftOffset) {
            noteText.style.transform = `translateX(${(tooltip.offsetWidth - ((windowWidth - 40) - leftOffset))}px)`
          }
          noteText.style.left = 'auto';
          noteText.style.right = '-.25rem';
        } else {
          // ÐºÐ¾Ð³Ð´Ð° Ð¸ÐºÐ¾Ð½ÐºÐ° Ð±Ð»Ð¸Ð¶Ðµ Ðº Ð»ÐµÐ²Ð¾Ð¼Ñƒ ÐºÑ€Ð°ÑŽ
          if (tooltip.offsetWidth > (windowWidth - 40) - leftOffset) {
            noteText.style.transform = `translateX(${-(tooltip.offsetWidth - ((windowWidth - 40) - leftOffset))}px)`
          }
          noteText.style.left = '.25rem';
          noteText.style.right = 'auto';
        }

        if (windowWidth < 470) {
          noteText.style.left = 0
          noteText.style.transform = `translateX(${(-(leftOffset - 28)) + ((windowWidth / 2) - 40) - ((tooltip.offsetWidth / 2) - 15) }px)`;
        }

      }

      // ÐµÑÐ»Ð¸ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚ Ð±Ð»Ð¸Ð¶Ðµ Ðº Ð²ÐµÑ€Ñ…Ð½Ð¾Ð¼Ñƒ ÐºÑ€Ð°ÑŽ ÑÐºÑ€Ð°Ð½Ð° - Ð²Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ Ð¿Ð¾Ð´ÑÐºÐ°Ð·Ñƒ ÑÐ½Ð¸Ð·Ñƒ Ð¾Ñ‚ Ð½ÐµÐ³Ð¾
      // Ð¸Ð½Ð°Ñ‡Ðµ ÑÐ²ÐµÑ€Ñ…Ñƒ
      if (e.target.closest('.js--courses-accord-content') || e.target.closest('.js--element-overflow')) {
        const notesParentBounding = e.target.closest('.js--courses-accord-content').getBoundingClientRect();
        // eslint-disable-next-line no-unused-vars
        const locationDifference = rect.top - notesParentBounding.top;
        const heightTooltip = tooltip.offsetHeight;
        if (heightTooltip >= locationDifference) {
          noteText.style.top = 'calc(100% + .25rem)';
          noteText.style.bottom = 'auto';
        } else if (heightTooltip < locationDifference && windowHeight / 2 < topOffset) {
          noteText.style.top = 'auto';
          noteText.style.bottom = 'calc(100% + .25rem)';
          // eslint-disable-next-line no-empty
        } else if (heightTooltip < locationDifference && windowHeight / 2 > topOffset) {
          noteText.style.top = 'calc(100% + .25rem)';
          noteText.style.bottom = 'auto';
        }
      } else {

        // Ð½Ð¸Ð·
        // eslint-disable-next-line no-lonely-if
        if (windowHeight / 2 > topOffset) {
          noteText.classList.remove('up')
          noteText.classList.add('down')

          noteText.style.top = 'calc(100% + .25rem)';
          noteText.style.bottom = 'auto';
        } else {
          noteText.classList.remove('down')
          noteText.classList.add('up')
          noteText.style.top = 'auto';
          noteText.style.bottom = 'calc(100% + .25rem)';
        }
      }
    }
    if (e.target.classList.contains('content-note__text')) {
      e.target.classList.add('active')
      if (e.target.closest('.js--content-note')){
        e.target.closest('.js--content-note').classList.add('active');
      }

    }
    if ((e.fromElement && e.toElement) && (e.fromElement.nodeName === 'SPAN' && e.toElement.nodeName === 'A')) {
      if (e.target.closest('.content-note__text')) {
        e.target.closest('.content-note__text').classList.add('active');
      }
      if (e.target.closest('.js--content-note')) {
        e.target.closest('.js--content-note').classList.add('active')
      }
    }

  });

  document.addEventListener('mouseout', (e) => {
    if (e.target.classList.contains('content-note__text')) {
      e.target.classList.remove('active');
      if (e.target.closest('.js--content-note')){
        e.target.closest('.js--content-note').classList.remove('active');
      }

    }
    if (e.target.matches('.js--content-note')) {
      e.target.querySelector('.content-note__text').classList.remove('active');
      e.target.classList.remove('active');
    }
    if ((e.fromElement && e.toElement) && (e.fromElement.nodeName === 'A' && e.toElement.hasAttribute('class') && e.toElement.getAttribute('class') !== null)) {
      if (e.target.closest('.content-note__text')) {
        e.target.closest('.content-note__text').classList.remove('active');
      }
      if (e.target.closest('.js--content-note')) {
        e.target.closest('.js--content-note').classList.remove('active')
      }
    }
  });
}
