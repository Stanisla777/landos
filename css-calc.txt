document.addEventListener('touchstart', (e) => {
  const isNote = e.target.classList.contains('js--content-note');
  const isNoteText = e.target.classList.contains('content-note__text') ||
                     e.target.closest('.content-note__text');

  if (isNoteText && !isNote) return;

  if (isNote && e.target.classList.contains('active')) {
    e.target.classList.remove('active');
    e.target.querySelector('.content-note__text').classList.remove('active');
    return;
  }

  if (!isNote) {
    notes.forEach(item => {
      item.classList.remove('active');
      item.querySelector('.content-note__text').classList.remove('active');
    });
    return;
  }

  if (isNote) {
    // Закрываем все
    notes.forEach(item => {
      item.classList.remove('active');
      item.querySelector('.content-note__text').classList.remove('active');
    });

    const noteText = e.target.querySelector('.content-note__text');

    // === 🔥 Сначала позиционируем, ПОКА тултип НЕ виден ===
    // Убедимся, что тултип "невидим", но измеримый
    noteText.style.visibility = 'hidden';
    noteText.style.opacity = '0';
    noteText.style.transition = 'none'; // отключаем анимацию на первый показ

    e.target.classList.add('active');
    noteText.classList.add('active');

    // Позиционируем ДО отображения
    positionTooltip(e.target);

    // === Теперь показываем с анимацией ===
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        noteText.style.visibility = 'visible';
        noteText.style.opacity = '1';
        noteText.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
      });
    });
  }
});
