document.addEventListener('copy', (event) => {
  // Игнорируем, если выделение внутри поля ввода
  const activeEl = document.activeElement;
  if (
    activeEl &&
    (activeEl.tagName === 'INPUT' ||
     activeEl.tagName === 'TEXTAREA' ||
     activeEl.contentEditable === 'true')
  ) {
    return;
  }

  const selection = window.getSelection();
  if (!selection || selection.toString().trim() === '') return;

  const selectedText = selection.toString();
  if (selectedText.length <= 20) return;

  const pageUrl = new URL(window.location.href);
  // Добавляем UTM-метки
  pageUrl.searchParams.set('utm_source', 'copy_text');
  pageUrl.searchParams.set('utm_medium', 'sharing');
  pageUrl.searchParams.set('utm_campaign', 'citation');

  const citation = `\n\nПодробнее на сайте ПАО ДОМ.РФ: ${pageUrl.toString()}`;

  // Устанавливаем модифицированный текст в буфер обмена
  event.clipboardData.setData('text/plain', selectedText + citation);
  event.preventDefault(); // Отменяем стандартное поведение
});
