// –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ RemoveClassBody —É–∂–µ –¥–æ—Å—Ç—É–ø–Ω–∞ (–≥–ª–æ–±–∞–ª—å–Ω–æ –∏–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞)
// –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –º–æ–¥—É–ª–∏ ‚Äî —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ:
// import { RemoveClassBody } from './path/to/your/file.js';

let isMobileMenuOpen = false;

document.addEventListener('DOMContentLoaded', () => {
  const btn = document.querySelector('.js--header-burger');
  const mobileMenu = document.querySelector('.js--mobile-menu');
  if (!btn || !mobileMenu) return;

  // === –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ header (–±–µ–∑ optional chaining) ===
  let header = null;
  const pageContent = btn.closest && btn.closest('.js--page-content');
  if (pageContent) {
    header = pageContent.querySelector('.header');
  }

  const containerYandexSearch = document.querySelector('.js--yandex-search');

  // === –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–Ω—é —Å debounce (–¥–ª—è iOS-—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏) ===
  let updateDebounceId;
  const updateMenuState = () => {
    clearTimeout(updateDebounceId);
    updateDebounceId = setTimeout(() => {
      isMobileMenuOpen = mobileMenu.classList.contains('active');
    }, 10);
  };

  updateMenuState();
  const observer = new MutationObserver(updateMenuState);
  observer.observe(mobileMenu, { attributes: true, attributeFilter: ['class'] });
  observer.observe(btn, { attributes: true, attributeFilter: ['class'] });

  // === –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è ‚Äî —Å –≤–∞—à–∏–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏ ===
  const closeMobileMenuIfOpen = () => {
    const body = document.body;

    // üîπ –£—Å–ª–æ–≤–∏–µ –∏–∑ –≤–∞—à–µ–≥–æ –∫–æ–¥–∞: –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ —Å—Ç–æ–∏—Ç 'body-modal-not-remove-else'
    if (
      !isMobileMenuOpen ||
      !mobileMenu.classList.contains('active') ||
      body.classList.contains('body-modal-not-remove-else')
    ) {
      return;
    }

    // üîπ –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –∏ –∫–Ω–æ–ø–∫—É
    mobileMenu.classList.remove('active');
    if (btn.classList.contains('open')) {
      btn.classList.remove('open');
    }
    if (header && header.classList.contains('z-ind')) {
      header.classList.remove('z-ind');
    }

    // üîπ –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –∞–∫–∫–æ—Ä–¥–µ–æ–Ω—ã (–≤–∞—à–∞ –ª–æ–≥–∏–∫–∞)
    const accordions = mobileMenu.querySelectorAll('.header__mobile-menu-item.js-accordion-parent');
    for (let i = 0; i < accordions.length; i++) {
      const item = accordions[i];
      item.classList.remove('active');
      const bodyEl = item.querySelector('.js-accordion-body');
      if (bodyEl) {
        bodyEl.setAttribute('style', 'max-height:0;');
      }
    }

    // üîπ –£—Å–ª–æ–≤–∏—è –¥–ª—è RemoveClassBody ‚Äî –∫–∞–∫ —É –≤–∞—Å (–¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞)
    const hasModalClasses = body.classList.contains('body-modal') && body.classList.contains('body-additional-class');
    if (hasModalClasses) {
      // –í–∞—Ä–∏–∞–Ω—Ç 1: –µ—Å—Ç—å containerYandexSearch, –Ω–æ –æ–Ω –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω
      if (
        containerYandexSearch &&
        !containerYandexSearch.classList.contains('active')
      ) {
        safeCallRemoveClassBody();
      }
      // –í–∞—Ä–∏–∞–Ω—Ç 2: containerYandexSearch –≤–æ–æ–±—â–µ –Ω–µ—Ç
      else if (!containerYandexSearch) {
        safeCallRemoveClassBody();
      }
    }

    isMobileMenuOpen = false;
  };

  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–∑–æ–≤
  function safeCallRemoveClassBody() {
    if (typeof RemoveClassBody === 'function') {
      RemoveClassBody();
    } else if (typeof window?.RemoveClassBody === 'function') {
      window.RemoveClassBody();
    }
  }

  // === –ü–æ–¥–ø–∏—Å–∫–∞ —á–µ—Ä–µ–∑ matchMedia (—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ + iOS-safe) ===
  const mediaQuery = window.matchMedia('(min-width: 1225px)');

  const handleMediaChange = (e) => {
    if (e.matches) {
      closeMobileMenuIfOpen();
    }
  };

  // –°–æ–≤–º–µ—Å—Ç–∏–º–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
  if (mediaQuery.addEventListener) {
    mediaQuery.addEventListener('change', handleMediaChange);
  } else if (mediaQuery.addListener) {
    mediaQuery.addListener(handleMediaChange); // legacy, –Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  if (mediaQuery.matches) {
    closeMobileMenuIfOpen();
  }

  // –≠–∫—Å–ø–æ—Ä—Ç (–Ω–∞ —Å–ª—É—á–∞–π —Ä—É—á–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞)
  window.closeMobileMenuIfOpen = closeMobileMenuIfOpen;
});
