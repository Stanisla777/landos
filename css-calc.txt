/* eslint-disable */
import AddClassBody from './redesign-site/disallow-body-scrolling';
import RemoveClassBody from './redesign-site/allow-body-scrolling';

// Защита от двойной инициализации
let isInitialized = false;

export function closeModal(id) {
  const modalWindow = document.getElementById(id);
  if (!modalWindow) return;

  if (modalWindow.querySelector('.js--stories-body-video video')) {
    modalWindow.querySelector('.js--stories-body-video video').pause();
  }

  const promice = new Promise((resolve) => {
    if (modalWindow.classList.contains('open')) {
      if (modalWindow.querySelector('.select-list__selection-window')) {
        modalWindow.querySelector('.select-list__selection-window').classList.remove('opacity');
        setTimeout(() => {
          modalWindow.classList.remove('open');
        }, 200);
      } else {
        modalWindow.classList.remove('open');
      }
    } else if (modalWindow.classList.contains('show')) {
      modalWindow.classList.remove('show');
    }

    document.body.classList.remove('modal-opened', 'body-modal-not-remove', 'body-modal-not-remove-else');

    if (!document.body.classList.contains('non-scroll-for-body') && document.body.classList.contains('body-additional-class')) {
      RemoveClassBody();
    }

    resolve();
  }).then(() =>
    new Promise((resolve) => {
      setTimeout(() => {
        // Можно раскомментировать, если нужно убирать body-modal позже
        // document.body.classList.remove('body-modal');
        resolve();
      }, 500);
    })
  );

  return promice;
}

export function modals() {
  if (isInitialized) return;
  isInitialized = true;

  // === 1. Открытие модалок — делегирование ===
  document.addEventListener('click', (e) => {
    const opener = e.target.closest('.js--modal-opener[data-modal]');
    if (!opener) return;

    e.preventDefault();

    const modalSelector = opener.dataset.modal;
    const modal = document.querySelector(modalSelector);
    if (!modal) {
      console.warn(`Модальное окно не найдено: ${modalSelector}`);
      return;
    }

    // Подстановка программы
    if (opener.dataset.program) {
      const input = document.querySelector('label.prog input');
      if (input) input.value = opener.dataset.program;
    }

    // Открытие
    modal.classList.add('open');

    // Анимация select-list
    const selectWindow = modal.querySelector('.select-list__selection-window');
    if (selectWindow) {
      setTimeout(() => {
        selectWindow.classList.add('opacity');
      }, 400);
    }

    // Блокировка скролла
    document.body.classList.add(
      'modal-opened',
      'body-modal-not-remove-else',
      'body-modal-not-remove'
    );
    AddClassBody();
  });

  // === 2. Закрытие модалок — делегирование ===
  document.addEventListener('click', (e) => {
    // Кнопка закрытия
    const closer = e.target.closest('.js--modal-closer');
    if (closer) {
      const modal = closer.closest('.modal');
      if (modal) closeModal(modal.id);
      return;
    }

    // Клик по фону (вне содержимого)
    const modal = e.target.closest('.modal');
    if (modal && !e.target.closest('.js--modal, .modal__wrapper')) {
      closeModal(modal.id);
    }
  });
}

// Если catalogModal тоже должен работать с динамикой — его тоже нужно делегировать
export function catalogModal() {
  // Просто делегируем клик на весь документ
  document.addEventListener('click', (e) => {
    const opener = e.target.closest('.js--ct-modal-opener');
    if (!opener) return;

    const program = opener.getAttribute('data-program');
    const input = document.querySelector('label.prog input');
    if (program && input) {
      input.value = program;
    }

    const modal = document.querySelector('#modalcall');
    if (modal) {
      modal.classList.add('open');
      document.body.classList.add('modal-opened');
    }
  });
}
