/**
 * Методы для работы с кнопками "Добавить в избранное"
 */
const BOOKMARKS = {
  debugLog: true, // Для отладки. TODO Убрать после отладки
  showButtonHints: false,  // Временное решение для отображения результата операций с Избранным. TODO Обсудить и либо переделать, либо убрать
  showButtonErrorModals: true,  // Отображать ошибку в модальном окне

  /**
   * Возвращает все кнопки "добавить в избранное" без валидации
   * @returns {NodeListOf<Element>}
   */
  getBookmarkButtonsUnvalidatedAll() {
    return document.querySelectorAll('.js--btn-bookmark')
  },

  /**
   * Возвращает все кнопки "добавить в избранное"
   * @returns {NodeListOf<Element>}
   */
  getBookmarkButtonsAll() {
    return document.querySelectorAll(`.js--btn-bookmark[data-iblockid][data-elementid]`)
  },

  /**
   * Возвращает набор одинаковых кнопок одного и того же материала (Например на странице льготной гос-программы две кнопки: для десктопа и мобилки)
   * @param iblockId
   * @param elementId
   * @returns {*}
   */
  getSameBookmarkButtons(iblockId, elementId) {
    return document.querySelectorAll(`.js--btn-bookmark[data-iblockid="${iblockId}"][data-elementid="${elementId}"]`)
  },

  /**
   * События для кнопки "Добавить в Избранное"
   * 
   * ИЗМЕНЕНИЕ: Событие клика делегировано на document для поддержки динамически добавляемых кнопок.
   * Раньше: Каждая кнопка имела свой обработчик через button.addEventListener('click', ...)
   * Теперь: Один обработчик на document, который использует closest() для поиска кнопки
   * 
   * ПОЧЕМУ ЭТО БЕЗОПАСНО:
   * 1. closest() безопасен - если элемент не найден, вернет null
   * 2. Проверки атрибутов (dataset.iblockid, dataset.elementid) делают код устойчивым к ошибкам
   * 3. e.preventDefault() и e.stopPropagation() защищают от нежелательных действий
   * 4. Удаление предыдущего обработчика предотвращает дублирование событий
   * 5. Код работает с динамически добавленными кнопками (например, при подгрузке контента через AJAX)
   */
  bindBookmarkButtons() {
    // Удаляю предыдущий обработчик, если он был (защита от дублей при повторном вызове)
    if (this._bookmarkClickHandler) {
      document.removeEventListener('click', this._bookmarkClickHandler);
    }

    // Создаю новый обработчик события
    this._bookmarkClickHandler = (e) => {
      // Ищем ближайшую кнопку "Добавить в избранное" от точки клика
      const button = e.target.closest('.js--btn-bookmark');
      if (!button) return; // Если клик не по кнопке - выходим

      // Проверяем наличие обязательных атрибутов
      if (!button.dataset?.iblockid) {
        if (this.debugLog) console.warn('У кнопки "Добавить в Избранное" не указан атрибут iblockid', button);
        return;
      }
      if (!button.dataset?.elementid) {
        if (this.debugLog) console.warn('У кнопки "Добавить в Избранное" не указан атрибут elementid', button);
        return;
      }

      // Отменяем переход по ссылке (если кнопка внутри <a>) и всплытие события
      e.preventDefault();
      e.stopPropagation();

      const iblockId = button.dataset.iblockid;
      const elementId = button.dataset.elementid;

      // Требуется авторизация
      if (button.classList.contains('js--need-auth')) {
        if (this.debugLog) console.log('Кнопка "Добавить в Избранное", нужна авторизация');
        this.openModalAuth();
        return;
      }

      if (button.classList.contains('active')) {
        // Удаление из избранного
        if (this.debugLog) console.log('Кнопка "Добавить в Избранное", удаление материала');
        fetch('/api/local/personal/bookmarks/', {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'x-bitrix-csrf-token': window.BX.bitrix_sessid(),
          },
          body: JSON.stringify({
            iblockId: iblockId,
            elementId: elementId
          })
        })
          .then(response => {
            if (this.debugLog) console.log('response', response);
            if (!response.ok) {
              this.processResponseStatus(response.status, this.getBookmarkButtonsAll(), true);

              // Показываем подсказку об ошибке, если включено
              if (this.showButtonHints) {
                response.json().then(data => {
                  const sameButtons = this.getSameBookmarkButtons(iblockId, elementId);
                  if (sameButtons) {
                    sameButtons.forEach((btn) => {
                      this.showButtonHint(btn, 'Ошибка при удалении из избранного' + (this.debugLog ? `. [${data?.code}] ${data?.description}` : ''), 'error');
                    });
                  }
                });
              }

              // Открываем модальное окно с ошибкой, если включено
              if (this.showButtonErrorModals) {
                response.json().then(data => {
                  this.openModalError('Ошибка при удалении из избранного', data?.description);
                });
              }

              throw new Error('Сетевая ошибка: ' + response.status + ' ' + response.statusText);
            }
            return response.json();
          })
          .then(data => {
            if (this.debugLog) console.log('Кнопка "Добавить в Избранное", Запрос выполнен, ответ:', data);
            const sameButtons = this.getSameBookmarkButtons(iblockId, elementId);
            if (sameButtons) {
              sameButtons.forEach((btn) => {
                this.changeBookmarkButtonState(btn, 'removed');
                if (this.showButtonHints) {
                  this.showButtonHint(btn, 'Удалено из избранного');
                }
              });
            }
          })
          .catch(error => {
            if (this.debugLog) console.warn('Кнопка "Добавить в Избранное", Ошибка:', error);
          });
      } else {
        // Добавление в избранное
        if (this.debugLog) console.log('Кнопка "Добавить в Избранное", добавление материала');
        fetch('/api/local/personal/bookmarks/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-bitrix-csrf-token': window.BX.bitrix_sessid(),
          },
          body: JSON.stringify({
            iblockId: iblockId,
            elementId: elementId
          })
        })
          .then(response => {
            if (this.debugLog) console.log('response', response);
            if (!response.ok) {
              this.processResponseStatus(response.status, this.getBookmarkButtonsAll(), true);
              
              // Показываем подсказку об ошибке, если включено
              if (this.showButtonHints) {
                response.json().then(data => {
                  const sameButtons = this.getSameBookmarkButtons(iblockId, elementId);
                  if (sameButtons) {
                    sameButtons.forEach((btn) => {
                      this.showButtonHint(btn, 'Ошибка при добавлении в избранное' + (this.debugLog ? `. [${data?.code}] ${data?.description}` : ''), 'error');
                    });
                  }
                });
              }
              
              // Открываем модальное окно с ошибкой, если включено
              if (this.showButtonErrorModals) {
                response.json().then(data => {
                  this.openModalError('Ошибка при добавлении в избранное', data?.description);
                });
              }
              
              throw new Error('Сетевая ошибка: ' + response.status + ' ' + response.statusText);
            }
            return response.json();
          })
          .then(data => {
            if (this.debugLog) console.log('Кнопка "Добавить в Избранное", Запрос выполнен, ответ:', data);
            const sameButtons = this.getSameBookmarkButtons(iblockId, elementId);
            if (sameButtons) {
              sameButtons.forEach((btn) => {
                this.changeBookmarkButtonState(btn, 'added');
                if (this.showButtonHints) {
                  this.showButtonHint(btn, 'Добавлено в избранное');
                }
              });
            }
          })
          .catch(error => {
            if (this.debugLog) console.warn('Кнопка "Добавить в Избранное", Ошибка:', error);
          });
      }
    };

    // Вешаем один обработчик на document (делегирование события)
    document.addEventListener('click', this._bookmarkClickHandler);
  },

  /**
   * Временное решение для отображения результата операций с Избранным. TODO Обсудить и либо переделать, либо убрать
   * @param el - элемент с кнопкой Избранного
   * @param message - текст сообщения
   * @param type - тип хинта - success | warning | error
   * 
   * ИЗМЕНЕНИЕ: Функция вынесена из метода bindBookmarkButtons() в объект BOOKMARKS для переиспользования
   */
  showButtonHint(el, message, type = 'success') {
    if (el) {
      let timeout = 2000;
      const hint = document.createElement('div');
      hint.dataset.iblockid = el.dataset.iblockid;
      hint.dataset.elementid = el.dataset.elementid;
      hint.className = 'button_hint ' + type;
      hint.textContent = message + ' (для отладки)';
      hint.style.position = 'fixed';
      hint.style.left = '10px';
      hint.style.bottom = '10px';
      hint.style.fontSize = 'small';
      hint.style.backgroundColor = 'white';
      hint.style.padding = '20px';
      hint.style.borderRadius = '5px';
      hint.style.boxShadow = '0 5px 10px rgba(0, 0, 0, 0.2)';
      hint.style.zIndex = '100';
      hint.style.transition = '0.5s';
      hint.style.opacity = 0;

      switch (type) {
        case 'error':
          hint.style.color = 'red';
          timeout = 7000;
          break;
        case 'warning':
          hint.style.color = 'orange';
          timeout = 5000;
          break;
        case 'success':
          hint.style.color = 'green';
          break;
      }
      
      document.body.append(hint);
      setTimeout(() => { hint.style.opacity = 1; }, 10);
      setTimeout(() => {
        hint.style.opacity = 0;
        setTimeout(() => { hint.remove(); }, 1000);
      }, timeout);
    }
  },

  /**
   * Обрабатывает ответ API
   * @param status
   * @param buttons
   * @param bShowModalAuth
   */
  processResponseStatus(status, buttons, bShowModalAuth = false) {
    if (status === 401) {
      if (buttons) {
        buttons.forEach(button => {
          this.changeBookmarkButtonState(button, 'auth');
        });
      }
      if (bShowModalAuth) {
        this.openModalAuth();
      }
      throw new Error('Требуется авторизация');
    }

    if (status === 403) {
      if (buttons) {
        buttons.forEach(button => {
          this.changeBookmarkButtonState(button, 'auth');
        });
      }
      if (bShowModalAuth) {
        this.openModalAuth();
      }
      throw new Error('Нужно обновить страницу');
    }
  },

  /**
   * Получает актуальные данные о материалах в Избранном и обновляет состояние кнопок "Добавить в избранное"
   */
  updateBookmarkButtons() {
    const bookmarkButtonsValidAll = this.getBookmarkButtonsAll();
    if (!bookmarkButtonsValidAll) {
      if (this.debugLog) console.log('Кнопки "Добавить в избранное не найдены на странице');
      return;
    }
    
    fetch('/api/local/personal/bookmarks/', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'x-bitrix-csrf-token': window.BX.bitrix_sessid(),
      },
    })
      .then(response => {
        if (!response.ok) {
          this.processResponseStatus(response.status, bookmarkButtonsValidAll);
          bookmarkButtonsValidAll.forEach(button => {
            this.changeBookmarkButtonState(button, 'error');
          });
          throw new Error('Получение всех материалов из Избранного, Сетевая ошибка: ' + response.status + ' ' + response.statusText);
        }
        return response.json();
      })
      .then(data => {
        if (this.debugLog) console.log('Получение всех материалов из Избранного, Запрос выполнен, ответ:', data);
        if (data && data?.result) {
          bookmarkButtonsValidAll.forEach(button => {
            this.changeBookmarkButtonState(button); // очищаем состояние всех кнопок "Добавить в избранное"
          });
          const iblockIds = Object.keys(data.result);
          iblockIds.forEach(iblockId => {
            const elementIds = Object.keys(data.result[iblockId]);
            elementIds.forEach(elementId => {
              if (elementId) {
                const sameButtons = this.getSameBookmarkButtons(iblockId, elementId);
                if (sameButtons) {
                  sameButtons.forEach((button) => {
                    this.changeBookmarkButtonState(button, 'added');
                  });
                }
              }
            });
          });
        }
      })
      .catch(error => {
        if (this.debugLog) console.warn('Получение всех материалов из Избранного, Ошибка:', error);
      });
  },

  /**
   * Обновляет внешний вид кнопок "Добавить в избранное"
   * @param button
   * @param state
   */
  changeBookmarkButtonState(button, state = '') {
    if (button) {
      switch (state) {
        case 'auth':
          button.classList.remove('active');
          button.classList.add('js--need-auth');
          // button.innerText = 'Добавить в избранное *'
          break;
        case 'added':
          button.classList.remove('js--need-auth');
          button.classList.add('active');
          // button.innerText = 'Добавлено в избранное!!'
          break;
        case 'error':
          button.classList.remove('active');
          // button.innerText = 'Добавить в избранное(('
          break;
        case 'removed':
        default:
          button.classList.remove('js--need-auth');
          button.classList.remove('active');
          // button.innerText = 'Добавить в избранное!'
          break;
      }
    }
  },

  /**
   * Открывает модальное окно авторизации
   */
  openModalAuth() {
    const authModal = document.querySelector('#modal-registration-state-service');
    if (authModal) {
      authModal.classList.add('open');
      // if (document.body.classList.contains('body-modal')) {
      //   document.body.classList.add('body-modal-not-remove')
      // }

      // AddClassBody
      document.body.classList.add(
        'modal-opened',
        'body-modal-not-remove-else',
        'body-modal-not-remove'
      );
      document.body.classList.add('body-modal');
      document.body.classList.add('body-additional-class');
      document.body.setAttribute('style', `top:-${window.scrollY}px;position: fixed;`);
      document.ontouchmove = (e) => {
        e.preventDefault();
      };
    }
  },

  /**
   * Открывает модальное окно ошибки
   * ДОБАВЛЕНО БЭКЕНД-РАЗРАБОТЧИКОМ
   */
  openModalError(title, description = '') {
    if (!title) {
      return;
    }
    const authErrorModal = document.querySelector('#modal-lkfl-error');
    if (authErrorModal) {
      const modalTitle = authErrorModal.querySelector('.js--lkfl-error-title');
      if (modalTitle) {
        modalTitle.innerText = title;
      }
      const modalDescription = authErrorModal.querySelector('.js--lkfl-error-description');
      if (modalDescription) {
        modalDescription.innerText = description;
      }
      authErrorModal.classList.add('open');

      // AddClassBody
      document.body.classList.add(
        'modal-opened',
        'body-modal-not-remove-else',
        'body-modal-not-remove'
      );
      document.body.classList.add('body-modal');
      document.body.classList.add('body-additional-class');
      document.body.setAttribute('style', `top:-${window.scrollY}px;position: fixed;`);
      document.ontouchmove = (e) => {
        e.preventDefault();
      };
    }
  }
};
