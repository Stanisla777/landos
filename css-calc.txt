// ОБРАБОТЧИК УХОДА МЫШИ
function handleMouseOut(e) {
  // Проверяю, что e.target существует и имеет метод closest
  if (!e.target || !e.target.closest) return;

  const trigger = e.target.closest('.js--content-note-new');
  const relatedTarget = e.relatedTarget || e.toElement;

  // Проверяю, что уходим не на сам тултип
  const isTooltip = relatedTarget && typeof relatedTarget.closest === 'function' && 
                    relatedTarget.closest('.content-note__text-new');

  if (!trigger || isTooltip) {
    return;
  }

  // Отменяю предыдущий таймер
  if (tooltipCloseTimer) {
    clearTimeout(tooltipCloseTimer);
  }

  // Задержка перед скрытием для плавности
  tooltipCloseTimer = setTimeout(() => {
    if (activeTooltip && activeTrigger === trigger) {
      hideTooltip(activeTooltip);
    }
    tooltipCloseTimer = null;
  }, 150);
}

-------------------

// Инициализация
export default function contentNoteNew() {
  // === Закрываем тултип при скролле ===
  const handleScroll = () => {
    if (activeTooltip) {
      hideTooltip(activeTooltip);
    }
  };

  // Добавляю обработчики событий
  document.addEventListener('mouseover', handleMouseOver);
  // Использую mouseout вместо mouseleave для надёжности
  document.addEventListener('mouseout', handleMouseOut);
  document.addEventListener('click', handleClickOutside);
  window.addEventListener('resize', handleResize);

  // Скролл страницы
  window.addEventListener('scroll', handleScroll, { passive: true });
  // Прокрутка колёсиком мыши
  document.addEventListener('wheel', handleScroll, { passive: true });

  // Для мобильных устройств использую клик вместо наведения
  const isIOS = (/(iPad|iPhone|iPod)/.test(navigator.userAgent) && !window.MSStream) ||
    (navigator.userAgent.includes('Mac') && 'ontouchend' in document);

  if (isIOS || isMobileDevice()) {
    document.addEventListener('touchstart', handleClick, { passive: false });
    // Свайп на мобильных
    document.addEventListener('touchmove', handleScroll, { passive: true });
  }

  // Обработчик для закрытия по клику на крестики в мобильном тултипе
  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('js--close-mobile-tooltip') && activeTooltip) {
      hideTooltip(activeTooltip);
    }
  });
}
