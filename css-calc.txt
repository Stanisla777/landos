Демо-страницы с видео:
https://rssprosi-3100.sprosi.dev.ringsites.ahml.ru/education/video/testovoe-video-ot-vkvideo-ru/
https://rssprosi-3100.sprosi.dev.ringsites.ahml.ru/education/video/testovoe-video-ot-rutube-ru/

Видео с локальными файлами:

https://rssprosi-3100.sprosi.dev.ringsites.ahml.ru/education/video/sberezhenie-sredstv-v-krizisnoy-situatsii/

https://rssprosi-3100.sprosi.dev.ringsites.ahml.ru/education/video/keshbek-dlya-zhizni-kak-vernut-potrachennye-dengi/



document.addEventListener('DOMContentLoaded', initShareBlocks);

function initShareBlocks() {
  const shareTriggers = document.querySelectorAll('.js--soc-list-share');
  shareTriggers.forEach(trigger => {
    trigger.addEventListener('click', handleShareClick);
  });
}

function handleShareClick(e) {
  e.preventDefault();
  const trigger = e.currentTarget;
  const wrapper = trigger.closest('.js--soc-list-wrapper-share');
  if (!wrapper) return;

  // Получаем/кэшируем dropdown
  let dropdown = wrapper.querySelector('.soc-list__share');
  if (!dropdown) {
    dropdown = createShareDropdown(wrapper);
    wrapper.appendChild(dropdown);
  }

  // Пересчитываем позицию при каждом открытии (на случай скролла/динамики)
  positionDropdown(trigger, dropdown);

  // Показываем
  dropdown.style.display = 'block';

  // Добавляем обработчик закрытия (один раз)
  if (!dropdown.dataset.bound) {
    dropdown.dataset.bound = 'true';
    // Закрытие по клику на любой пункт
    dropdown.addEventListener('click', (ev) => {
      if (ev.target.closest('a, div[data-copy-link]')) {
        dropdown.style.display = 'none';
      }
    });

    // Закрытие по клику вне dropdown или trigger
    document.addEventListener('click', function onClickOutside(ev) {
      if (!dropdown.contains(ev.target) && !trigger.contains(ev.target)) {
        dropdown.style.display = 'none';
        // Можно отвязать, но лучше не делать — вдруг dropdown переиспользуется
        // document.removeEventListener('click', onClickOutside);
      }
    });
  }
}

function createShareDropdown(wrapper) {
  const servicesStr = wrapper.dataset.services || '[]';
  let services;
  try {
    // Заменяем возможные кавычки/без кавычек на JSON-совместимый вид
    const normalized = servicesStr
      .replace(/[\[\]']/g, '"')
      .replace(/,\s*}/g, '}')
      .replace(/\s+/g, ' ')
      .trim();
    services = JSON.parse(normalized);
  } catch (e) {
    console.error('Некорректный data-services:', servicesStr, e);
    services = [];
  }

  const url = encodeURIComponent(wrapper.dataset.url || location.href);
  const text = encodeURIComponent(wrapper.dataset.text || document.title);
  const imageUrl = encodeURIComponent(wrapper.dataset.image || '');

  const dropdown = document.createElement('div');
  dropdown.className = 'soc-list__share';
  dropdown.style.display = 'none'; // initially hidden

  const ul = document.createElement('ul');

  const serviceNames = {
    whatsapp: 'WhatsApp',
    telegram: 'Telegram',
    vkontakte: 'ВКонтакте',
    odnoklassniki: 'Одноклассники',
  };

  services.forEach(service => {
    if (!serviceNames[service]) return;

    const li = document.createElement('li');
    const a = document.createElement('a');
    const icon = document.createElement('div');
    const title = document.createElement('span');

    icon.className = `soc-list__share-icon ${service}`;
    title.className = 'soc-list__share-title';
    title.textContent = serviceNames[service];

    let shareUrl = '#';
    switch (service) {
      case 'whatsapp':
        shareUrl = `https://wa.me/?text=${text}%20${url}`;
        break;
      case 'telegram':
        shareUrl = `https://t.me/share/url?url=${url}&text=${text}`;
        break;
      case 'vkontakte':
        // Поддержка image (ограничение: image должен быть публичным URL)
        shareUrl = `https://vk.com/share.php?url=${url}&title=${text}&image=${imageUrl}&noparse=true`;
        break;
      case 'odnoklassniki':
        shareUrl = `https://connect.ok.ru/offer?url=${url}&title=${text}&imageUrl=${imageUrl}`;
        break;
    }

    a.href = shareUrl;
    a.target = '_blank';
    a.rel = 'noopener noreferrer';
    a.appendChild(icon);
    a.appendChild(title);
    li.appendChild(a);
    ul.appendChild(li);
  });

  // Всегда добавляем "Скопировать ссылку"
  const copyLi = document.createElement('li');
  const copyDiv = document.createElement('div');
  copyDiv.dataset.copyLink = '';

  const copyIcon = document.createElement('div');
  copyIcon.className = 'soc-list__share-icon copy-link';

  const copyTitle = document.createElement('span');
  copyTitle.className = 'soc-list__share-title';
  copyTitle.textContent = 'Скопировать ссылку';

  copyDiv.appendChild(copyIcon);
  copyDiv.appendChild(copyTitle);
  copyLi.appendChild(copyDiv);
  ul.appendChild(copyLi);

  dropdown.appendChild(ul);

  // Обработчик копирования
  copyDiv.addEventListener('click', (ev) => {
    ev.stopPropagation();
    const textToCopy = wrapper.dataset.url || location.href;
    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(textToCopy).then(() => {
        alert('Ссылка скопирована!');
      }).catch(err => {
        console.error('Не удалось скопировать:', err);
      });
    } else {
      // fallback для HTTP или старых браузеров
      const textarea = document.createElement('textarea');
      textarea.value = textToCopy;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand('copy');
        alert('Ссылка скопирована!');
      } catch (err) {
        console.error('Не удалось скопировать:', err);
      }
      document.body.removeChild(textarea);
    }
  });

  return dropdown;
}

function positionDropdown(trigger, dropdown) {
  const rect = trigger.getBoundingClientRect();
  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;

  // Позиционируем **под** кнопкой share (с отступом вниз)
  const top = rect.top + rect.height + scrollTop;
  const left = rect.left + scrollLeft;

  dropdown.style.top = `${top}px`;
  dropdown.style.left = `${left}px`;
}

