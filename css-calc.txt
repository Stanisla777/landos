// Позиционирование тултипа относительно родителя с классом .js--focus-on-parent
function positionTooltipRelativeToParent(trigger, tooltip) {
  const rect = trigger.getBoundingClientRect();
  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;

  const isMobileOrTablet = isMobileDevice();
  const isNarrow = window.matchMedia('(max-width: 480px)').matches;

  // Для мобильных устройств использую мобильный вид
  if (isMobileOrTablet || isNarrow) {
    tooltip.style.transform = 'translate(-50%, -50%)';
    tooltip.classList.add('mobile-tooltip');
    return;
  }

  // Сбрасываю позиционирование
  tooltip.style.left = '';
  tooltip.style.right = '';
  tooltip.style.top = '';
  tooltip.style.bottom = '';
  tooltip.style.transform = '';

  // Измеряю размеры тултипа
  const originalDisplay = tooltip.style.display;
  tooltip.style.display = 'block';
  tooltip.style.opacity = '0';
  const tooltipRect = tooltip.getBoundingClientRect();
  const tooltipWidth = tooltipRect.width;
  const tooltipHeight = tooltipRect.height;
  tooltip.style.display = originalDisplay;
  tooltip.style.opacity = '';

  // Находим родителя с классом .js--focus-on-parent
  const focusParent = trigger.closest('.js--focus-on-parent');
  if (!focusParent) {
    // Если родителя нет, используем обычное позиционирование
    positionTooltip(trigger, tooltip);
    return;
  }

  const parentRect = focusParent.getBoundingClientRect();

  // Определяю позиционирование для короткого текста
  if (tooltip.classList.contains('location-side')) {
    const iconCenterInParent = rect.left - parentRect.left + rect.width / 2;
    const parentCenter = parentRect.width / 2;
    const centerY = rect.top + rect.height / 2;
    const offset = 10;

    // Горизонтальное позиционирование
    if (iconCenterInParent > parentCenter) {
      // Иконка правее середины родителя → тултип слева от иконки
      // Проверяем, что тултип не выходит за левую границу родителя
      if (rect.left - tooltipWidth - offset >= parentRect.left) {
        tooltip.style.right = `${viewportWidth - rect.left + offset}px`;
        tooltip.classList.add('left');
        tooltip.classList.remove('right');
      } else {
        // Не помещается слева → показываем справа
        tooltip.style.left = `${rect.right + offset}px`;
        tooltip.classList.add('right');
        tooltip.classList.remove('left');
      }
    } else {
      // Иконка левее середины родителя → тултип справа от иконки
      // Проверяем, что тултип не выходит за правую границу родителя
      if (rect.right + tooltipWidth + offset <= parentRect.right) {
        tooltip.style.left = `${rect.right + offset}px`;
        tooltip.classList.add('right');
        tooltip.classList.remove('left');
      } else {
        // Не помещается справа → показываем слева
        tooltip.style.right = `${viewportWidth - rect.left + offset}px`;
        tooltip.classList.add('left');
        tooltip.classList.remove('right');
      }
    }

    // Вертикальное позиционирование (по центру иконки)
    tooltip.style.top = `${centerY - tooltipHeight / 2}px`;
    tooltip.classList.remove('up', 'down');

    return;
  }

  // Для длинного текста используем стандартное позиционирование

  // Горизонтальное позиционирование
  const iconCenterInParent = rect.left - parentRect.left + rect.width / 2;
  const parentCenter = parentRect.width / 2;
  const offset = 4;

  if (iconCenterInParent > parentCenter) {
    // Иконка правее середины родителя → тултип слева от иконки
    // Проверяем, что тултип не выходит за левую границу родителя
    if (rect.left - tooltipWidth - offset >= parentRect.left) {
      tooltip.style.left = 'auto';
      tooltip.style.right = `${viewportWidth - rect.right + offset}px`;
      tooltip.classList.add('left');
      tooltip.classList.remove('right');
    } else {
      // Не помещается слева → показываем справа
      tooltip.style.left = `${rect.left - offset}px`;
      tooltip.style.right = 'auto';
      tooltip.classList.add('right');
      tooltip.classList.remove('left');
    }
  } else {
    // Иконка левее середины родителя → тултип справа от иконки
    // Проверяем, что тултип не выходит за правую границу родителя
    if (rect.right + tooltipWidth + offset <= parentRect.right) {
      tooltip.style.left = `${rect.left - offset}px`;
      tooltip.style.right = 'auto';
      tooltip.classList.add('right');
      tooltip.classList.remove('left');
    } else {
      // Не помещается справа → показываем слева
      tooltip.style.left = 'auto';
      tooltip.style.right = `${viewportWidth - rect.right + offset}px`;
      tooltip.classList.add('left');
      tooltip.classList.remove('right');
    }
  }

  // Вертикальное позиционирование - УПРОЩЁННАЯ ВЕРСИЯ
  const iconCenterY = rect.top + rect.height / 2;
  const parentCenterY = parentRect.top + parentRect.height / 2;

  if (iconCenterY > parentCenterY) {
    // Иконка ниже середины родителя → тултип сверху
    tooltip.style.top = 'auto';
    tooltip.style.bottom = `${viewportHeight - rect.top + offset}px`;
    tooltip.classList.add('up');
    tooltip.classList.remove('down');
  } else {
    // Иконка выше середины родителя → тултип снизу
    tooltip.style.top = `${rect.bottom - offset}px`;
    tooltip.style.bottom = 'auto';
    tooltip.classList.add('down');
    tooltip.classList.remove('up');
  }
}
