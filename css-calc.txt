// Позиционирование тултипа относительно иконки по которой кликнули
function positionTooltip(trigger, tooltip) {
  const rect = trigger.getBoundingClientRect();
  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;

  const isMobileOrTablet = isMobileDevice();
  const isNarrow = window.matchMedia('(max-width: 480px)').matches;

  // Для мобильных устройств использую мобильный вид
  if (isMobileOrTablet || isNarrow) {
    tooltip.style.transform = 'translate(-50%, -50%)';
    tooltip.classList.add('mobile-tooltip');
    return;
  }

  // Сбрасываю позиционирование
  tooltip.style.left = '';
  tooltip.style.right = '';
  tooltip.style.top = '';
  tooltip.style.bottom = '';
  tooltip.style.transform = '';

  // Измеряю размеры тултипа
  const originalDisplay = tooltip.style.display;
  tooltip.style.display = 'block';
  tooltip.style.opacity = '0';
  const tooltipRect = tooltip.getBoundingClientRect();
  const tooltipWidth = tooltipRect.width;
  const tooltipHeight = tooltipRect.height;
  tooltip.style.display = originalDisplay;
  tooltip.style.opacity = '';

  // Проверяем наличие родителя с классом .js--focus-on-parent
  const focusParent = trigger.closest('.js--focus-on-parent');

  // Определяю позиционирование для короткого текста
  if (tooltip.classList.contains('location-side')) {
    let centerX, centerY;
    
    if (focusParent) {
      // Используем координаты относительно родителя
      const parentRect = focusParent.getBoundingClientRect();
      centerX = rect.left - parentRect.left + rect.width / 2;
      centerY = rect.top - parentRect.top + rect.height / 2;
      
      // Горизонтальное позиционирование относительно родителя
      if (parentRect.width / 2 < centerX) {
        // Иконка правее середины родителя → тултип слева от иконки
        if (rect.left - parentRect.left - tooltipWidth - 10 >= 0) {
          tooltip.style.right = `${parentRect.right - rect.left + 10}px`;
          tooltip.classList.add('left');
          tooltip.classList.remove('right');
        } else {
          tooltip.style.left = `${rect.right - parentRect.left + 10}px`;
          tooltip.classList.add('right');
          tooltip.classList.remove('left');
        }
      } else {
        // Иконка левее середины родителя → тултип справа от иконки
        if (rect.right - parentRect.left + tooltipWidth + 10 <= parentRect.width) {
          tooltip.style.left = `${rect.right - parentRect.left + 10}px`;
          tooltip.classList.add('right');
          tooltip.classList.remove('left');
        } else {
          tooltip.style.right = `${parentRect.right - rect.left + 10}px`;
          tooltip.classList.add('left');
          tooltip.classList.remove('right');
        }
      }
      
      // Вертикальное позиционирование относительно родителя
      tooltip.style.top = `${centerY - tooltipHeight / 2 + parentRect.top}px`;
    } else {
      // Обычное позиционирование относительно экрана
      centerX = rect.left + rect.width / 2;
      centerY = rect.top + rect.height / 2;
      
      if (viewportWidth / 2 < centerX) {
        // Иконка правее середины экрана → тултип слева от иконки
        if (rect.left - tooltipWidth - 10 >= 0) {
          tooltip.style.right = `${viewportWidth - rect.left + 10}px`;
          tooltip.classList.add('left');
          tooltip.classList.remove('right');
        } else {
          tooltip.style.left = `${rect.right + 10}px`;
          tooltip.classList.add('right');
          tooltip.classList.remove('left');
        }
      } else {
        // Иконка левее середины экрана → тултип справа от иконки
        if (rect.right + tooltipWidth + 10 <= viewportWidth) {
          tooltip.style.left = `${rect.right + 10}px`;
          tooltip.classList.add('right');
          tooltip.classList.remove('left');
        } else {
          tooltip.style.right = `${viewportWidth - rect.left + 10}px`;
          tooltip.classList.add('left');
          tooltip.classList.remove('right');
        }
      }
      
      tooltip.style.top = `${centerY - tooltipHeight / 2}px`;
    }
    
    tooltip.classList.remove('up', 'down');
    return;
  }

  // Для длинного текста используем стандартное позиционирование

  // Горизонтальное позиционирование
  let leftOffset;
  if (focusParent) {
    const parentRect = focusParent.getBoundingClientRect();
    leftOffset = rect.left - parentRect.left + rect.width / 2;
  } else {
    leftOffset = rect.left + rect.width / 2;
  }

  const offset = 4; // отступ от иконки

  if (focusParent) {
    const parentRect = focusParent.getBoundingClientRect();
    if (parentRect.width / 2 < leftOffset) {
      // Иконка правее середины родителя → тултип слева от иконки
      tooltip.style.left = 'auto';
      tooltip.style.right = `${parentRect.right - rect.right + offset}px`;
      tooltip.classList.add('left');
      tooltip.classList.remove('right');
    } else {
      // Иконка левее середины родителя → тултип справа от иконки
      tooltip.style.left = `${rect.left - parentRect.left - offset}px`;
      tooltip.style.right = 'auto';
      tooltip.classList.add('right');
      tooltip.classList.remove('left');
    }
  } else {
    if (viewportWidth / 2 < leftOffset) {
      // Иконка правее середины экрана → тултип слева от иконки
      tooltip.style.left = 'auto';
      tooltip.style.right = `${viewportWidth - rect.right + offset}px`;
      tooltip.classList.add('left');
      tooltip.classList.remove('right');
    } else {
      // Иконка левее середины экрана → тултип справа от иконки
      tooltip.style.left = `${rect.left - offset}px`;
      tooltip.style.right = 'auto';
      tooltip.classList.add('right');
      tooltip.classList.remove('left');
    }
  }

  // Вертикальное позиционирование
  let topOffset;
  if (focusParent) {
    const parentRect = focusParent.getBoundingClientRect();
    topOffset = rect.top - parentRect.top + rect.height / 2;
  } else {
    topOffset = rect.top + rect.height / 2;
  }

  if (focusParent) {
    const parentRect = focusParent.getBoundingClientRect();
    if (parentRect.height / 2 < topOffset) {
      // Иконка ниже середины родителя → тултип сверху
      tooltip.style.top = 'auto';
      tooltip.style.bottom = `${parentRect.bottom - rect.top + offset}px`;
      tooltip.classList.add('up');
      tooltip.classList.remove('down');
    } else {
      // Иконка выше середины родителя → тултип снизу
      tooltip.style.top = `${rect.bottom - parentRect.top - offset}px`;
      tooltip.style.bottom = 'auto';
      tooltip.classList.add('down');
      tooltip.classList.remove('up');
    }
  } else {
    if (viewportHeight / 2 < topOffset) {
      // Иконка ниже середины экрана → тултип сверху
      tooltip.style.top = 'auto';
      tooltip.style.bottom = `${viewportHeight - rect.top + offset}px`;
      tooltip.classList.add('up');
      tooltip.classList.remove('down');
    } else {
      // Иконка выше середины экрана → тултип снизу
      tooltip.style.top = `${rect.bottom - offset}px`;
      tooltip.style.bottom = 'auto';
      tooltip.classList.add('down');
      tooltip.classList.remove('up');
    }
  }
}
