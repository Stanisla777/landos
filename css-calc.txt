// modules/copy-citation.js

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

document.addEventListener('copy', (event) => {
  const activeEl = document.activeElement;
  if (
    activeEl &&
    (activeEl.tagName === 'INPUT' ||
     activeEl.tagName === 'TEXTAREA' ||
     activeEl.contentEditable === 'true')
  ) {
    return;
  }

  const selection = window.getSelection();
  if (!selection || selection.toString().trim() === '') return;

  const selectedText = selection.toString();
  if (selectedText.length <= 20) return;

  const pageUrl = new URL(window.location.href);
  const pathSegments = pageUrl.pathname.split('/').filter(segment => segment !== '');

  let utmContent;

  // Специальная обработка для /education/...
  if (pathSegments[0] === 'education' && pathSegments[1]) {
    const secondSegment = pathSegments[1];
    // Разрешаем только нужные подкатегории
    if (['marathons', 'courses', 'video', 'tests'].includes(secondSegment)) {
      utmContent = secondSegment;
    } else {
      // Если второй сегмент не из списка — можно использовать его или fallback
      utmContent = secondSegment; // или 'education' — по желанию
    }
  } else {
    // Обычный случай: первый сегмент или homepage
    utmContent = pathSegments[0] || 'homepage';
  }

  // Устанавливаем UTM-метки
  pageUrl.searchParams.set('utm_source', 'copy_text');
  pageUrl.searchParams.set('utm_medium', 'sharing');
  pageUrl.searchParams.set('utm_campaign', 'citation');
  pageUrl.searchParams.set('utm_content', utmContent);

  const citationText = 'Подробнее на сайте ПАО ДОМ.РФ: ' + pageUrl.toString();

  const plain = selectedText + '\n\n' + citationText;

  const html = `
    ${escapeHtml(selectedText).replace(/\n/g, '<br>')}
    <br><br>
    Подробнее на сайте ПАО ДОМ.РФ: <a href="${pageUrl}">${pageUrl}</a>
  `.trim();

  event.clipboardData.setData('text/plain', plain);
  event.clipboardData.setData('text/html', html);
  event.preventDefault();
});
