/**
 * –°–æ–±—ã—Ç–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ" ‚Äî –î–ï–õ–ï–ì–ò–†–û–í–ê–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
 */
bindBookmarkButtons() {
  // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –µ—Å–ª–∏ –æ–Ω –±—ã–ª (–∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π)
  if (this._bookmarkClickHandler) {
    document.removeEventListener('click', this._bookmarkClickHandler);
  }

  // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
  this._bookmarkClickHandler = (e) => {
    const button = e.target.closest('.js--btn-bookmark');
    if (!button) return;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤
    if (!button.dataset?.iblockid) {
      if (this.debugLog) console.warn('–£ –∫–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ" –Ω–µ —É–∫–∞–∑–∞–Ω –∞—Ç—Ä–∏–±—É—Ç iblockid', button);
      return;
    }
    if (!button.dataset?.elementid) {
      if (this.debugLog) console.warn('–£ –∫–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ" –Ω–µ —É–∫–∞–∑–∞–Ω –∞—Ç—Ä–∏–±—É—Ç elementid', button);
      return;
    }

    // üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –æ—Ç–º–µ–Ω—è–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ (–µ—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –≤–Ω—É—Ç—Ä–∏ <a>)
    e.preventDefault();
    e.stopPropagation();

    const iblockId = button.dataset.iblockid;
    const elementId = button.dataset.elementid;

    // –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    if (button.classList.contains('js--need-auth')) {
      if (this.debugLog) console.log('–ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ", –Ω—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
      this.openModalAuth();
      return;
    }

    if (button.classList.contains('active')) {
      // –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
      if (this.debugLog) console.log('–ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ", —É–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞');
      fetch('/api/local/personal/bookmarks/', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'x-bitrix-csrf-token': window.BX.bitrix_sessid(),
        },
        body: JSON.stringify({
          iblockId: iblockId,
          elementId: elementId
        })
      })
        .then(response => {
          if (this.debugLog) console.log('response', response);
          if (!response.ok) {
            this.processResponseStatus(response.status, this.getBookmarkButtonsAll(), true);

            if (this.showButtonHints) {
              response.json().then(data => {
                const sameButtons = this.getSameBookmarkButtons(iblockId, elementId);
                if (sameButtons) {
                  sameButtons.forEach((btn) => {
                    this.showButtonHint(btn, '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ' + (this.debugLog ? `. [${data?.code}] ${data?.description}` : ''), 'error');
                  });
                }
              });
            }
            throw new Error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ' + response.status + ' ' + response.statusText);
          }
          return response.json();
        })
        .then(data => {
          if (this.debugLog) console.log('–ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ", –ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω, –æ—Ç–≤–µ—Ç:', data);
          const sameButtons = this.getSameBookmarkButtons(iblockId, elementId);
          if (sameButtons) {
            sameButtons.forEach((btn) => {
              this.changeBookmarkButtonState(btn, 'removed');
              if (this.showButtonHints) {
                this.showButtonHint(btn, '–£–¥–∞–ª–µ–Ω–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
              }
            });
          }
        })
        .catch(error => {
          if (this.debugLog) console.warn('–ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ", –û—à–∏–±–∫–∞:', error);
        });
    } else {
      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
      if (this.debugLog) console.log('–ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ", –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞');
      fetch('/api/local/personal/bookmarks/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-bitrix-csrf-token': window.BX.bitrix_sessid(),
        },
        body: JSON.stringify({
          iblockId: iblockId,
          elementId: elementId
        })
      })
        .then(response => {
          if (this.debugLog) console.log('response', response);
          if (!response.ok) {
            this.processResponseStatus(response.status, this.getBookmarkButtonsAll(), true);
            if (this.showButtonHints) {
              response.json().then(data => {
                const sameButtons = this.getSameBookmarkButtons(iblockId, elementId);
                if (sameButtons) {
                  sameButtons.forEach((btn) => {
                    this.showButtonHint(btn, '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ' + (this.debugLog ? `. [${data?.code}] ${data?.description}` : ''), 'error');
                  });
                }
              });
            }
            throw new Error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ' + response.status + ' ' + response.statusText);
          }
          return response.json();
        })
        .then(data => {
          if (this.debugLog) console.log('–ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ", –ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω, –æ—Ç–≤–µ—Ç:', data);
          const sameButtons = this.getSameBookmarkButtons(iblockId, elementId);
          if (sameButtons) {
            sameButtons.forEach((btn) => {
              this.changeBookmarkButtonState(btn, 'added');
              if (this.showButtonHints) {
                this.showButtonHint(btn, '–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ');
              }
            });
          }
        })
        .catch(error => {
          if (this.debugLog) console.warn('–ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ", –û—à–∏–±–∫–∞:', error);
        });
    }
  };

  // –í–µ—à–∞–µ–º –æ–¥–∏–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ document
  document.addEventListener('click', this._bookmarkClickHandler);
},








--------------------------------------------------












/**
 * –ò–∑–±—Ä–∞–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
 */

/*if (document.readyState !== 'loading') {
  processBtnBookmark();
  initCheckboxValidation('.js--btn-registration-state');
} else {
  document.addEventListener('DOMContentLoaded', function () {
    processBtnBookmark();
    initCheckboxValidation('.js--btn-registration-state');
  });
}*/


/*
–°–æ–±—ã—Ç–∏—è –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∫–Ω–æ–ø–∫—É –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –ì–æ—Å—É—Å–ª—É–≥–∏, –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ —á–µ–∫–±–æ–∫—Å–æ–≤ —Å –∞—Ç—Ä–∏–±—É—Ç–æ–º required
–ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—é –∫–ª–∏–∫ –¥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è onclick, –ø—Ä–æ–≤–µ—Ä—è—é —á–µ–∫–±–æ–∫—Å—ã –∏ –µ—Å–ª–∏ –æ–Ω–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∑–∞–ø—É—Å–∫–∞—é –±–∏—Ç—Ä–∏–∫—Å–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –∫–æ—Ç–æ—Ä—ã–π —Å–æ—Ö—Ä–∞–Ω—è—é –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –¥–æ —É–¥–∞–ª–µ–Ω–∏—è

–µ—Å–ª–∏ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã —Ç–æ —è –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —É–±—Ä–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ onclick –Ω–µ –ø–æ–¥—Å—Ç–∞–≤–ª—è—é –≤ –∫–Ω–æ–ø–∫—É
–ê–≤—Ç–æ—Ä - –°—Ç–∞–Ω–∏—Å–ª–∞–≤ –©—ë–≥–æ–ª–µ–≤
 */


// import AddClassBody from "../../../../src/js/modules/redesign-site/disallow-body-scrolling";

function runAfterDomReady() {
  // 1. –ø–æ—Å—Ç–∞–≤–∏–ª –ø–µ—Ä–≤—ã–º, —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–ª–æ –∏ —è —Å–ø–æ–∫–æ–π–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏–ª onclick –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
  initCheckboxValidation('.js--btn-registration-state');

  // 2. –ø–æ—Å—Ç–∞–≤–∏–ª –ø–æ—Å–ª–µ –º–æ–µ–≥–æ –º–µ—Ç–æ–¥–∞, —á—Ç–æ-—Ç–æ —Ç—É—Ç –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∫–ª–∏–∫
  BOOKMARKS.bindBookmarkButtons() // –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫–∏ "–¥–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"
  BOOKMARKS.updateBookmarkButtons() // –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫ "–¥–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"
}

// –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π
if (document.readyState !== 'loading') {
  runAfterDomReady();
} else {
  document.addEventListener('DOMContentLoaded', runAfterDomReady);
}


/**
 * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é —á–µ–∫–±–æ–∫—Å–æ–≤ –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º onclick –Ω–∞ –∫–Ω–æ–ø–∫–µ.
 * –ü–æ–∫–∞–∑—ã–≤–∞—é –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —á–µ–∫–±–æ–∫—Å—ã –Ω–µ –æ—Ç–º–µ—á–µ–Ω—ã.
 * –î–æ–±–∞–≤–ª—è—é –∫–ª–∞—Å—Å input_error –∫ –±–ª–æ–∫—É .js--checkbox_wrapper.
 *
 */
function initCheckboxValidation(buttonSelector) {
  const btn = document.querySelector(buttonSelector);
  if (!btn) {
    return;
  }

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º onclick –≤ –ø–µ–µ–º–µ–Ω–Ω—É—é
  const originalOnclick = btn.getAttribute('onclick');
  const originalHandler = btn.onclick;

  // –£–¥–∞–ª—è—é onclick –∏–∑ —ç–ª–µ–º–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª –±–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
  btn.removeAttribute('onclick');
  btn.onclick = null;

  // –û–ø—Ä–µ–¥–µ–ª—è—é –æ–±—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ)
  const container = btn.closest('.js--modal') || document;
  const checkboxWrappers = container.querySelectorAll('.js--checkbox_wrapper');
  const errorClass = 'js--input__error_required';


  function getErrorMessage(checkbox) {
    return checkbox.getAttribute('data-required-hint') || '–°–æ–≥–ª–∞—Å–∏—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏';
  }

  function showError(formBlock, message) {
    if (!formBlock.querySelector('.' + errorClass)) {
      const error = document.createElement('p');
      error.className = 'input__error ' + errorClass;
      error.textContent = message;
      formBlock.appendChild(error);
    }
  }

  function removeError(formBlock) {
    const error = formBlock.querySelector('.' + errorClass);
    if (error) {
      error.remove();
    }
  }

  // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
  document.addEventListener('click', function (e) {
    const targetBtn = document.querySelector(buttonSelector);
    if (!targetBtn || !e.target.closest(buttonSelector)) {
      return;
    }

    e.preventDefault();

    let hasError = false;

    // –£–¥–∞–ª—è—é —Å—Ç–∞—Ä—ã–µ –æ—à–∏–±–∫–∏ –∏ –∫–ª–∞—Å—Å—ã
    checkboxWrappers.forEach(function (wrapper) {
      const formBlock = wrapper.querySelector('.feed_back__user-form-block');
      if (formBlock) {
        removeError(formBlock);
      }
      wrapper.classList.remove('input_error');
    });

    // –ü—Ä–æ–≤–µ—Ä—è—é —á–µ–∫–±–æ–∫—Å—ã
    checkboxWrappers.forEach(function (wrapper) {
      const checkbox = wrapper.querySelector('input[type="checkbox"]');
      const formBlock = wrapper.querySelector('.feed_back__user-form-block');

      if (!checkbox || !formBlock) {
        return;
      }

      if (checkbox.hasAttribute('required') && !checkbox.checked) {
        const message = getErrorMessage(checkbox);
        showError(formBlock, message);
        wrapper.classList.add('input_error');
        hasError = true;
      }
    });

    if (hasError) {
      return;
    }

    // –í—ã–ø–æ–ª–Ω—è—é –∫–ª–∏–∫ —Å –±–∏—Ç—Ä–∏–∫—Å–æ–≤–æ—ã–º –º–µ—Ç–æ–¥–æ–º onclick
    if (originalHandler && typeof originalHandler === 'function') {
      console.log('initCheckboxValidation: –≤—ã–ø–æ–ª–Ω—è–µ–º originalHandler');
      originalHandler.call(targetBtn, e);
    } else if (originalOnclick) {
      console.log('initCheckboxValidation: –≤—ã–ø–æ–ª–Ω—è–µ–º originalOnclick –∫–∞–∫ —Å—Ç—Ä–æ–∫—É');
      try {
        new Function(originalOnclick)();
      } catch (err) {
        console.log('initCheckboxValidation: –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ onclick:', err);
      }
    } else {
      console.log('initCheckboxValidation: –Ω–µ—á–µ–≥–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å ‚Äî onclick –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');
    }
  }, true); // useCapture: true

}


/**
 * –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–Ω–æ–ø–∫–∞–º–∏ "–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"
 */
const BOOKMARKS = {
  debugLog: true, // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏. TODO –£–±—Ä–∞—Ç—å –ø–æ—Å–ª–µ –æ—Ç–ª–∞–¥–∫–∏
  showButtonHints: true,  // –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ò–∑–±—Ä–∞–Ω–Ω—ã–º. TODO –û–±—Å—É–¥–∏—Ç—å –∏ –ª–∏–±–æ –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å, –ª–∏–±–æ —É–±—Ä–∞—Ç—å

  /**
   * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –∫–Ω–æ–ø–∫–∏ "–¥–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ" –±–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
   * @returns {NodeListOf<Element>}
   */
  getBookmarkButtonsUnvalidatedAll() {
    return document.querySelectorAll('.js--btn-bookmark')
  },

  /**
   * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –∫–Ω–æ–ø–∫–∏ "–¥–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"
   * @returns {NodeListOf<Element>}
   */
  getBookmarkButtonsAll() {
    return document.querySelectorAll(`.js--btn-bookmark[data-iblockid][data-elementid]`)
  },

  /**
   * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–±–æ—Ä –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –∫–Ω–æ–ø–æ–∫ –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ (–ù–∞–ø—Ä–∏–º–µ—Ä –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ª—å–≥–æ—Ç–Ω–æ–π –≥–æ—Å-–ø—Ä–æ–≥—Ä–∞–º–º—ã –¥–≤–µ –∫–Ω–æ–ø–∫–∏: –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ –∏ –º–æ–±–∏–ª–∫–∏)
   * @param iblockId
   * @param elementId
   * @returns {*}
   */
  getSameBookmarkButtons(iblockId, elementId) {
    return document.querySelectorAll(`.js--btn-bookmark[data-iblockid="${iblockId}"][data-elementid="${elementId}"]`)
  },

  /**
   * –°–æ–±—ã—Ç–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ"
   */
  bindBookmarkButtons() {
    try {
      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –í–°–ï –∫–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ" –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –∑–∞—Ö–æ—Ç—è—Ç –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ —Ç–æ–ª—å–∫–æ –Ω–∞ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
      const buttons = BOOKMARKS.getBookmarkButtonsUnvalidatedAll()
      if (buttons) {
        buttons.forEach(function (button, index) {
          if (!button.dataset?.iblockid) {
            if (BOOKMARKS.debugLog) console.warn(`–£ ${index + 1}-–π –∫–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ" –Ω–µ —É–∫–∞–∑–∞–Ω –∞—Ç—Ä–∏–±—É—Ç iblockid`)
            return;
          }
          if (!button.dataset?.elementid) {
            if (BOOKMARKS.debugLog) console.warn(`–£ ${index + 1}-–π –∫–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ" –Ω–µ —É–∫–∞–∑–∞–Ω –∞—Ç—Ä–∏–±—É—Ç elementid`)
            return;
          }

          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞
          button.addEventListener('click', function (e) {
            e.preventDefault()
            e.stopPropagation()
            const iblockId = this.dataset?.iblockid
            const elementId = this.dataset?.elementid
            if (!(iblockId && elementId)) {
              if (BOOKMARKS.debugLog) console.warn('–£ –∫–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ" –Ω–µ —É–∫–∞–∑–∞–Ω—ã –∞—Ç—Ä–∏–±—É—Ç—ã', button);
              return;
            }

            // –¢—Ä–æ–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
            if (this.classList.contains('js--need-auth')) {
              if (BOOKMARKS.debugLog) console.log('–ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ", –Ω—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è')
              BOOKMARKS.openModalAuth()
              return
            }

            if (this.classList.contains('active')) {


              // –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
              if (BOOKMARKS.debugLog) console.log('–ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ", —É–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞')
              fetch('/api/local/personal/bookmarks/', {
                method: 'DELETE',
                headers: {
                  'Content-Type': 'application/json',
                  'x-bitrix-csrf-token': window.BX.bitrix_sessid(),
                },
                body: JSON.stringify({
                  iblockId: iblockId,
                  elementId: elementId
                })
              })
                .then(response => {
                  if (BOOKMARKS.debugLog) console.log('response', response)
                  if (!response.ok) {
                    BOOKMARKS.processResponseStatus(response.status, BOOKMARKS.getBookmarkButtonsAll(),true)

                    if (BOOKMARKS.showButtonHints) {
                      response.json().then(data => {
                        const sameButtons = BOOKMARKS.getSameBookmarkButtons(iblockId, elementId)
                        if (sameButtons) {
                          sameButtons.forEach((button) => {
                            showButtonHint(button, '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ' + (BOOKMARKS.debugLog ? `. [${data?.code}] ${data?.description}` : ''), 'error')
                          })
                        }
                      })
                    }

                    throw new Error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ' + response.status + ' ' + response.statusText)
                  }
                  return response.json()
                })
                .then(data => {
                  if (BOOKMARKS.debugLog) console.log('–ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ", –ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω, –æ—Ç–≤–µ—Ç:', data)

                  // –ú–µ–Ω—è–µ–º –≤—Å–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ (–ù–∞–ø—Ä–∏–º–µ—Ä –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ª—å–≥–æ—Ç–Ω–æ–π –≥–æ—Å-–ø—Ä–æ–≥—Ä–∞–º–º—ã –¥–≤–µ –∫–Ω–æ–ø–∫–∏: –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ –∏ –º–æ–±–∏–ª–∫–∏)
                  const sameButtons = BOOKMARKS.getSameBookmarkButtons(iblockId, elementId)
                  if (sameButtons) {
                    sameButtons.forEach((button) => {
                      BOOKMARKS.changeBookmarkButtonState(button, 'removed')
                      if (BOOKMARKS.showButtonHints) {
                        showButtonHint(button, '–£–¥–∞–ª–µ–Ω–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ')
                      }
                    })
                  }
                })
                .catch(error => {
                  if (BOOKMARKS.debugLog) console.warn('–ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ", –û—à–∏–±–∫–∞:', error)
                })
            } else {


              // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
              if (BOOKMARKS.debugLog) console.log('–ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ", –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞')
              fetch('/api/local/personal/bookmarks/', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'x-bitrix-csrf-token': window.BX.bitrix_sessid(),
                },
                body: JSON.stringify({
                  iblockId: iblockId,
                  elementId: elementId
                })
              })
                .then(response => {
                  if (BOOKMARKS.debugLog) console.log('response', response)
                  if (!response.ok) {
                    BOOKMARKS.processResponseStatus(response.status, BOOKMARKS.getBookmarkButtonsAll(),true)
                    if (BOOKMARKS.showButtonHints) {
                      response.json().then(data => {
                        const sameButtons = BOOKMARKS.getSameBookmarkButtons(iblockId, elementId)
                        if (sameButtons) {
                          sameButtons.forEach((button) => {
                            showButtonHint(button, '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ' + (BOOKMARKS.debugLog ? `. [${data?.code}] ${data?.description}` : ''), 'error')
                          })
                        }
                      })
                    }
                    throw new Error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ' + response.status + ' ' + response.statusText)
                  }
                  return response.json()
                })
                .then(data => {
                  if (BOOKMARKS.debugLog) console.log('–ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ", –ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω, –æ—Ç–≤–µ—Ç:', data)

                  // –ú–µ–Ω—è–µ–º –≤—Å–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ (–ù–∞–ø—Ä–∏–º–µ—Ä –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ª—å–≥–æ—Ç–Ω–æ–π –≥–æ—Å-–ø—Ä–æ–≥—Ä–∞–º–º—ã –¥–≤–µ –∫–Ω–æ–ø–∫–∏: –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ –∏ –º–æ–±–∏–ª–∫–∏)
                  const sameButtons = BOOKMARKS.getSameBookmarkButtons(iblockId, elementId)
                  if (sameButtons) {
                    sameButtons.forEach((button) => {
                      BOOKMARKS.changeBookmarkButtonState(button, 'added')
                      if (BOOKMARKS.showButtonHints) {
                        showButtonHint(button, '–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ')
                      }
                    })
                  }
                })
                .catch(error => {
                  if (BOOKMARKS.debugLog) console.warn('–ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ", –û—à–∏–±–∫–∞:', error)
                })
            }
          })
        })
      }
    } catch (e) {
      console.warn(e)
    }

    /**
     * –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ò–∑–±—Ä–∞–Ω–Ω—ã–º. TODO –û–±—Å—É–¥–∏—Ç—å –∏ –ª–∏–±–æ –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å, –ª–∏–±–æ —É–±—Ä–∞—Ç—å
     * @param el - —ç–ª–µ–º–µ–Ω—Ç —Å –∫–Ω–æ–ø–∫–æ–π –ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
     * @param message - —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
     * @param type - —Ç–∏–ø —Ö–∏–Ω—Ç–∞ - success | warning | error
     */
    function showButtonHint(el, message, type = 'success') {
      if (el) {
        let timeout = 2000
        const hint = document.createElement('div')
        hint.dataset.iblockid = el.dataset.iblockid
        hint.dataset.elementid = el.dataset.elementid
        hint.className = 'button_hint ' + type
        hint.textContent = message + ' (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)'
        hint.style.position = 'fixed'
        hint.style.left = '10px'
        hint.style.bottom = '10px'
        hint.style.fontSize = 'small'
        hint.style.backgroundColor = 'white'
        hint.style.padding = '20px'
        hint.style.borderRadius = '5px'
        hint.style.boxShadow = '0 5px 10px rgba(0, 0, 0, 0.2)'
        hint.style.zIndex = '100'
        hint.style.transition = '0.5s'
        hint.style.opacity = 0


        switch (type) {
          case 'error':
            hint.style.color = 'red'
            timeout = 7000
            break
          case 'warning':
            hint.style.color = 'orange'
            timeout = 5000
            break
          case 'success':
            hint.style.color = 'green'
            break
        }
        // el.parentElement.append(hint);
        document.body.append(hint);
        setTimeout(function (hint) {
          hint.style.opacity = 1
        }, 10, hint)
        setTimeout(function (hint) {
          hint.style.opacity = 0
          setTimeout(function (hint) {
            hint.remove()
          }, 1000, hint)
        }, timeout, hint)
      }
    }
  },

  /**
   * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç API
   * @param status
   * @param buttons
   * @param bShowModalAuth
   */
  processResponseStatus(status, buttons,bShowModalAuth = false) {
    if (status === 401) {
      if (buttons) {
        buttons.forEach(button => {
          BOOKMARKS.changeBookmarkButtonState(button, 'auth')
        })
      }
      if (bShowModalAuth){
        BOOKMARKS.openModalAuth()
      }
      throw new Error('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è')
    }

    if (status === 403) {
      if (buttons) {
        buttons.forEach(button => {
          BOOKMARKS.changeBookmarkButtonState(button, 'auth')
        })
      }
      if (bShowModalAuth){
        BOOKMARKS.openModalAuth()
      }
      throw new Error('–ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É')
    }
  },


  /**
   * –ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ "–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"
   */
  updateBookmarkButtons() {
    const bookmarkButtonsValidAll = BOOKMARKS.getBookmarkButtonsAll()
    if (!bookmarkButtonsValidAll) {
      if (BOOKMARKS.debugLog) console.log('–ö–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ')
      return
    }
    fetch('/api/local/personal/bookmarks/', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'x-bitrix-csrf-token': window.BX.bitrix_sessid(),
      },
    })
      .then(response => {
        if (!response.ok) {

          BOOKMARKS.processResponseStatus(response.status, bookmarkButtonsValidAll)

          bookmarkButtonsValidAll.forEach(button => {
            BOOKMARKS.changeBookmarkButtonState(button, 'error')
          })
          throw new Error('–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏–∑ –ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ, –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ' + response.status + ' ' + response.statusText)
        }
        return response.json()
      })
      .then(data => {
        if (BOOKMARKS.debugLog) console.log('–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏–∑ –ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ, –ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω, –æ—Ç–≤–µ—Ç:', data)
        if (data && data?.result) {
          bookmarkButtonsValidAll.forEach(button => {
            BOOKMARKS.changeBookmarkButtonState(button) // –æ—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ "–î–æ–±–∞–≤–∏—Ç—å –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ"
          })
          const iblockIds = Object.keys(data.result);
          iblockIds.forEach(iblockId => {
            const elementIds = Object.keys(data.result[iblockId]);
            elementIds.forEach(elementId => {
              if (elementId) {
                const sameButtons = BOOKMARKS.getSameBookmarkButtons(iblockId, elementId)
                if (sameButtons) {
                  sameButtons.forEach((button) => {
                    BOOKMARKS.changeBookmarkButtonState(button, 'added')
                  })
                }
              }
            })
          })
        }
      })
      .catch(error => {
        if (BOOKMARKS.debugLog) console.warn('–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏–∑ –ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ, –û—à–∏–±–∫–∞:', error)
      })
  },

  /**
   * –û–±–Ω–æ–≤–ª—è–µ—Ç –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –∫–Ω–æ–ø–æ–∫ "–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"
   * @param button
   * @param state
   */
  changeBookmarkButtonState(button, state = '') {
    if (button) {
      switch (state) {
        case 'auth':
          button.classList.remove('active')
          button.classList.add('js--need-auth')
          // button.innerText = '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ *'
          break
        case 'added':
          button.classList.remove('js--need-auth')
          button.classList.add('active')
          // button.innerText = '–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ!!'
          break
        case 'error':
          button.classList.remove('active')
          // button.innerText = '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ(('
          break
        case 'removed':
        default:
          button.classList.remove('js--need-auth')
          button.classList.remove('active')
          // button.innerText = '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ!'
          break
      }
    }
  },

  /**
   * –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
   */
  openModalAuth() {
    const authModal = document.querySelector('#modal-registration-state-service')
    if (authModal) {
      authModal.classList.add('open');
      // if (document.body.classList.contains('body-modal')) {
      //   document.body.classList.add('body-modal-not-remove')
      // }

      // AddClassBody
      document.body.classList.add(
        'modal-opened',
        'body-modal-not-remove-else',
        'body-modal-not-remove'
      );
      document.body.classList.add('body-modal');
      document.body.classList.add('body-additional-class');
      document.body.setAttribute('style', `top:-${window.scrollY}px;position: fixed;`);
      document.ontouchmove = (e) => {
        e.preventDefault();
      };
    }
  }

}




