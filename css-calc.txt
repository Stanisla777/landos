// Позиционирование тултипа относительно экрана
function positionTooltip(trigger, tooltip) {
  const rect = trigger.getBoundingClientRect();
  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;

  const isNarrow = window.matchMedia('(max-width: 480px)').matches;

  // Для мобильных телефонов использую мобильный вид (только класс, без стилей)
  if (isMobilePhone() || isNarrow) {
    tooltip.classList.add('mobile-tooltip');
    return;
  }

  // ... остальной код без изменений ...
}

// Позиционирование тултипа относительно родителя с классом .js--focus-on-parent
function positionTooltipRelativeToParent(trigger, tooltip) {
  const rect = trigger.getBoundingClientRect();
  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;

  const isNarrow = window.matchMedia('(max-width: 480px)').matches;

  // Для мобильных телефонов использую мобильный вид (только класс, без стилей)
  if (isMobilePhone() || isNarrow) {
    tooltip.classList.add('mobile-tooltip');
    return;
  }

  // ... остальной код без изменений ...
}

-------------------------------------------------------------------------

// Показ тултипа
function showTooltip(trigger, content) {
  // Закрываю предыдущий тултип, если он есть
  if (activeTooltip) {
    hideTooltip(activeTooltip);
  }

  // Создаю новый тултип
  const tooltip = createTooltip(content, trigger);
  const container = ensureTooltipContainer();
  
  // Сначала добавляем в контейнер
  container.appendChild(tooltip);

  // Определяю, какую функцию позиционирования использовать
  const focusParent = trigger.closest('.js--focus-on-parent');
  if (focusParent) {
    positionTooltipRelativeToParent(trigger, tooltip);
  } else {
    positionTooltip(trigger, tooltip);
  }

  // === КЛЮЧЕВОЕ: правильная последовательность анимации как в поделиться ===
  requestAnimationFrame(() => {
    // Сбрасываем активные классы для гарантии
    container.classList.remove('active');
    tooltip.classList.remove('active');
    
    requestAnimationFrame(() => {
      const isNarrow = window.matchMedia('(max-width: 480px)').matches;
      const isMobile = isMobilePhone() || isNarrow;
      
      // Устанавливаем transition только в момент анимации
      if (isMobile) {
        tooltip.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
      } else {
        tooltip.style.transition = 'opacity 0.2s ease';
      }

      // Добавляем активные классы
      container.classList.add('active');
      tooltip.classList.add('active');
      
      // Устанавливаем видимость
      tooltip.style.opacity = '1';
      tooltip.style.pointerEvents = 'auto';
      
      // Для мобильных добавляем класс контейнера
      if (isMobile) {
        container.classList.add('mobile-tooltip');
      }
    });
  });

  // Сохраняю ссылки на текущий тултип
  activeTooltip = tooltip;
  activeTrigger = trigger;

  // Для мобильных добавляю блокировку скролла
  if (isMobileDevice()) {
    addClassBody();
  }
}

--------------------------------------------

// Скрытие тултипа
function hideTooltip(tooltip) {
  if (!tooltip) return;

  // Отменяю таймер закрытия
  if (tooltipCloseTimer) {
    clearTimeout(tooltipCloseTimer);
    tooltipCloseTimer = null;
  }

  const isNarrow = window.matchMedia('(max-width: 480px)').matches;
  const isMobile = isMobilePhone() || isNarrow;

  // Устанавливаем transition для анимации закрытия
  if (isMobile) {
    tooltip.style.transition = 'transform 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
  } else {
    tooltip.style.transition = 'opacity 0.2s ease';
  }

  tooltip.style.pointerEvents = 'none';
  tooltip.style.opacity = '0';
  tooltip.classList.remove('active');

  setTimeout(() => {
    if (tooltip.parentNode) {
      tooltip.parentNode.removeChild(tooltip);
      
      // Удаляем класс контейнера, если больше нет тултипов
      if (!tooltipContainer.querySelector('.content-note__text-new')) {
        tooltipContainer.classList.remove('active');
        tooltipContainer.classList.remove('mobile-tooltip');
      }
    }

    // Разблокирую скролл для мобильных
    if (isMobileDevice()) {
      removeClassBody();
    }
  }, isMobile ? 300 : 200); // 300ms для мобильных, 200ms для десктопа

  activeTooltip = null;
  activeTrigger = null;
}

---------------------------------
// Создаю общий контейнер один раз
function ensureTooltipContainer() {
  if (!tooltipContainer) {
    tooltipContainer = document.createElement('div');
    tooltipContainer.className = 'tooltip-popup-container';
    Object.assign(tooltipContainer.style, {
      position: 'fixed',
      top: '0',
      left: '0',
      width: '100%',
      height: '100%',
      pointerEvents: 'none',
      zIndex: '2147483646',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
    });
    document.body.appendChild(tooltipContainer);
  }
  
  return tooltipContainer;
}

----------------------------------
// Обработчик изменения размера окна
function handleResize() {
  if (activeTooltip && activeTrigger) {
    const focusParent = activeTrigger.closest('.js--focus-on-parent');
    if (focusParent) {
      positionTooltipRelativeToParent(activeTrigger, activeTooltip);
    } else {
      positionTooltip(activeTrigger, activeTooltip);
    }
  }

  // Для мобильных устройств закрываю тултип при изменении ориентации
  const isNarrow = window.matchMedia('(max-width: 480px)').matches;

  if (isMobilePhone() && !isNarrow && activeTooltip) {
    hideTooltip(activeTooltip);
  }
}

-----------------------------
// Контейнер тултипа
.tooltip-popup-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 2147483646;
  display: flex;
  align-items: center;
  justify-content: center;

  &.active {
    pointer-events: auto;
  }

  // Для мобильных телефонов (устанавливается в JS)
  &.mobile-tooltip {
    align-items: flex-end;
    justify-content: center;
  }
}

// Тултип
.content-note__text-new {
  position: absolute;
  background: #fff;
  border-radius: 8px;
  padding: 16px 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  max-width: 320px;
  opacity: 0;
  pointer-events: none;
  // УБРАЛИ transition из CSS! Управляется через JS
  font-size: 14px;
  line-height: 1.4;
  color: #333;

  &.active {
    opacity: 1;
    pointer-events: auto;
  }

  // Мобильный вид — ТОЛЬКО состояния, без transition!
  &.mobile-tooltip {
    position: fixed;
    padding: 24px;
    padding-top: 16px;
    bottom: 0;
    top: unset !important;
    left: 50%;
    transform: translate(-50%, 101%) !important; // Начальное состояние (за пределами экрана)
    height: max-content;
    width: 101%;
    border-top-left-radius: 16px;
    border-top-right-radius: 16px;
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
    max-height: 80vh;
    overflow-y: auto;
    background-color: #fff;

    &.active {
      transform: translate(-50%, 0) !important; // Конечное состояние (в пределах экрана)
    }
  }

  // ... остальные стили без изменений ...
}

