Демо-страницы с видео:
https://rssprosi-3100.sprosi.dev.ringsites.ahml.ru/education/video/testovoe-video-ot-vkvideo-ru/
https://rssprosi-3100.sprosi.dev.ringsites.ahml.ru/education/video/testovoe-video-ot-rutube-ru/

Видео с локальными файлами:

https://rssprosi-3100.sprosi.dev.ringsites.ahml.ru/education/video/sberezhenie-sredstv-v-krizisnoy-situatsii/

https://rssprosi-3100.sprosi.dev.ringsites.ahml.ru/education/video/keshbek-dlya-zhizni-kak-vernut-potrachennye-dengi/



https://t.me/share/url?url=https%3A%2F%2Fxn--h1alcedd.xn--d1aqf.xn--p1ai&text=%D0%9A%D0%B0%D0%BA%D0%BE%D0%B9-%D1%82%D0%BE%20%D1%82%D0%B5%D0%BA%D1%81%D1%82&utm_source=share2



------------------------------------------------------------------------------------------------------------------

/* eslint-disable */

// Глобальные переменные
function RemoveClassBody() {
  if (!document.body.classList.contains('body-modal-modals')) {
    document.body.classList.remove('body-modal');
    document.body.classList.remove('body-additional-class');
  }
  const scrollY = document.body.style.top;
  document.body.style.position = '';
  document.body.style.top = '';
  window.scrollTo(0, parseInt(scrollY || '0') * -1);
}
function AddClassBody() {
  document.body.classList.add('body-modal');
  document.body.classList.add('body-additional-class');
  document.body.setAttribute('style', `top:-${window.scrollY}px;position: fixed;`);
  document.ontouchmove = (e) => {
    e.preventDefault();
  };
}

let activeDropdown = null;
let activeTrigger = null;
let popupContainer = null;
const defaultType = '1';

const dropdownCache = new WeakMap();

// Определение мобильного/планшетного устройства по User-Agent
function isMobileDevice() {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

//определяю, что открыто в мобильнике
function isMobilePhone() {
  const ua = navigator.userAgent;
  // iPhone (но не iPad)
  if (/iPhone/.test(ua) && !/iPad/.test(ua)) return true;
  // Android + Mobile — только телефоны
  if (/Android/.test(ua) && /Mobile/.test(ua)) return true;
  return false;
}


// Создаём общий контейнер один раз
function ensurePopupContainer() {
  if (!popupContainer) {
    popupContainer = document.createElement('div');
    popupContainer.className = 'soc-share-popup-container';
    Object.assign(popupContainer.style, {
      position: 'fixed',
      top: '0',
      left: '0',
      width: '100%',
      height: '100%',
      pointerEvents: 'none',
      zIndex: '2147483647', // как у Яндекса — максимальный
    });
    document.body.appendChild(popupContainer);
  }
  return popupContainer;
}


// Обработчик клика
function handleShareClick(trigger, e) {
  if (!trigger || typeof trigger.closest !== 'function') {
    console.warn('Некорректный триггер:', trigger);
    return;
  }
  e.preventDefault();
  const wrapper = trigger.closest('.js--soc-list-wrapper-share');
  if (!wrapper) return;

  // Если popup открыт И клик по той же кнопке → просто закрываем
  if (activeDropdown && activeTrigger === trigger) {
    hideDropdown(activeDropdown);
    return;
  }

  // Иначе: закрываем текущий (если есть) и открываем новый
  if (activeDropdown) {
    hideDropdown(activeDropdown);
  }

  // Передаём wrapper и данные для AJAX внутрь createShareDropdown
  const rawUrl = wrapper.dataset.url || location.href;
  const rawText = wrapper.dataset.text || document.title;
  const rawImage = wrapper.dataset.image || '';

  let dropdown = dropdownCache.get(wrapper);
  if (!dropdown) {
    // Получаем данные ДО создания popup’а
    const rawUrl = wrapper.dataset.url || location.href;
    const rawText = wrapper.dataset.text || document.title;
    const rawImage = wrapper.dataset.image || '';

    dropdown = createShareDropdown(wrapper, rawUrl, rawText, rawImage); // ← ПЕРЕДАЁМ
    ensurePopupContainer().appendChild(dropdown);
    dropdownCache.set(wrapper, dropdown);
  }

  showDropdown(dropdown, trigger);

  // shareAjax БОЛЬШЕ НЕ ВЫЗЫВАЕТСЯ ЗДЕСЬ
}

//отправка данных
function shareAjax(id, type = defaultType,element_count, count){
  BX.ajax({
    url: '/local/components/dev/likes/templates/mini/ajax.php',
    data: {
      element_id : id,
      type : type,
      share : 'Y'
    },
    method: 'POST',
    dataType: 'html',
    timeout: 30,
    async: true,
    processData: true,
    scriptsRunFirst: true,
    emulateOnload: true,
    start: true,
    cache: false,
    onsuccess: function(data){
      element_count.textContent=count + 1;
    },
    onfailure: function(){

    }
  });
}

// Показ popup’а
function showDropdown(dropdown, trigger) {
  dropdown.style.display = 'block';
  dropdown.style.opacity = '0';
  dropdown.style.pointerEvents = 'none';

  const isMobilePortrait = isMobileDevice() && window.matchMedia('(max-width: 480px)').matches;

  positionDropdown(trigger, dropdown);

  requestAnimationFrame(() => {
    if (popupContainer) {
      popupContainer.classList.add('active');
    }
    dropdown.classList.remove('active');

    requestAnimationFrame(() => {
      if (isMobilePortrait) {
        dropdown.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
      } else {
        dropdown.style.transition = 'opacity 0.2s ease';
      }

      dropdown.classList.add('active');

      if (isMobileDevice()) {
        AddClassBody();
        if (popupContainer) popupContainer.classList.add('mobile-share');
        dropdown.classList.add('mobile-share');
      }

      // Добавляем класс ТОЛЬКО для телефонов
      if (isMobilePhone()) {
        dropdown.classList.add('mobile-phone-device');
      }

      dropdown.style.opacity = '1';
      dropdown.style.pointerEvents = 'auto';
    });
  });

  activeDropdown = dropdown;
  activeTrigger = trigger;
  if (!isMobileDevice()) {
    window.addEventListener('scroll', onScroll, { passive: true });
  }
}

// Скрытие popup’а
function hideDropdown(dropdown) {
  if (!dropdown) return;

  const isMobilePortrait = isMobileDevice() && window.matchMedia('(max-width: 480px)').matches;

  dropdown.style.pointerEvents = 'none';

  if (isMobilePortrait) {
    dropdown.style.transition = 'transform 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
  } else {
    dropdown.style.transition = 'opacity 0.2s ease';
  }

  dropdown.classList.remove('active');

  setTimeout(() => {
    dropdown.style.display = 'none';
    dropdown.style.transition = '';

    if (popupContainer) popupContainer.classList.remove('active');
    if (dropdown.classList.contains('mobile-share')) {
      RemoveClassBody();
      if (popupContainer) popupContainer.classList.remove('mobile-share');
      dropdown.classList.remove('mobile-share');
    }
  }, 300); // ← 300 мс — гарантирует завершение анимации

  activeDropdown = null;
  activeTrigger = null;
  window.removeEventListener('scroll', onScroll);
}

// Позиционирование popup-а (мгновенно, без transition!)
function positionDropdown(trigger, dropdown) {
  const rect = trigger.getBoundingClientRect();
  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;

  const isMobileOrTablet = isMobileDevice();
  const isNarrow = window.matchMedia('(max-width: 480px)').matches;
  const isMobileShare = dropdown.classList.contains('mobile-share');

  if (isMobileOrTablet || isNarrow || isMobileShare) {
    return;
  }

  // Сбрасываем transform
  dropdown.style.transform = 'none';

  // Измеряем ширину и высоту
  const originalDisplay = dropdown.style.display;
  dropdown.style.display = 'block';
  dropdown.style.opacity = '0';
  const dropdownRect = dropdown.getBoundingClientRect();
  const dropdownWidth = dropdownRect.width;
  const dropdownHeight = dropdownRect.height;
  dropdown.style.display = originalDisplay;
  dropdown.style.opacity = '';

  // Горизонтальное позиционирование (как у вас)
  let left = rect.left;
  if (left + dropdownWidth > viewportWidth - 10) {
    left = rect.left - dropdownWidth + 10;
    if (left < 10) left = 10;
  }

  // Вертикальное позиционирование
  let top = rect.top + rect.height + 10; // под кнопкой

  // Если не помещается снизу → показываем СВЕРХУ
  if (top + dropdownHeight > viewportHeight - 10) {
    top = rect.top - dropdownHeight - 10;
    // Защита: не уходим за верхний край
    if (top < 10) top = 10;
  }

  dropdown.style.transform = `translate(${left}px, ${top}px)`;
}

// Обработчик скролла — мгновенный, как у Яндекса
function onScroll() {
  if (activeDropdown && activeTrigger) {
    positionDropdown(activeTrigger, activeDropdown);
  }
}

// Создание popup-а (внутри fixed-контейнера)
function createShareDropdown(wrapper, rawUrl, rawText, rawImage) {
  const servicesStr = (wrapper.dataset.services || '').trim();
  let services = [];
  if (servicesStr) {
    try {
      services = JSON.parse(servicesStr);
    } catch (_) {
      let cleaned = servicesStr.trim();
      if (cleaned.startsWith('[') && cleaned.endsWith(']')) {
        cleaned = cleaned.slice(1, -1).trim();
      }
      services = cleaned.split(',').map(s => s.trim()).filter(Boolean);
    }
  }
  if (!Array.isArray(services)) services = [];

  const dropdown = document.createElement('div');
  dropdown.className = 'soc-list__share';
  Object.assign(dropdown.style, {
    opacity: '0',
    pointerEvents: 'none',
  });

  // Мобильный хедер (без изменений)
  const mobileHeader = document.createElement('div');
  mobileHeader.className = 'soc-list__mobile-header';

  const urlText = document.createElement('p');
  urlText.textContent = rawText;

  const closeBtn = document.createElement('div');
  closeBtn.className = 'soc-list__mobile-header-close js--soc-list-mobile-header-close';

  const closeIcon = document.createElement('div');
  closeIcon.className = 'soc-list__mobile-header-close-icon';

  closeBtn.appendChild(closeIcon);
  mobileHeader.appendChild(urlText);
  mobileHeader.appendChild(closeBtn);

  closeBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    hideDropdown(dropdown);
  });

  dropdown.appendChild(mobileHeader);

  // Список сервисов
  const ul = document.createElement('ul');
  const serviceTitles = {
    whatsapp: 'WhatsApp',
    telegram: 'Telegram',
    vkontakte: 'ВКонтакте',
    max: 'MAX',
    odnoklassniki: 'Одноклассники',
  };

  services.forEach(service => {
    const title = serviceTitles[service];
    if (!title) return;

    const li = document.createElement('li');
    const item = document.createElement('div');
    item.className = 'soc-list__share-item';

    const icon = document.createElement('div');
    icon.className = `soc-list__share-icon ${service}-icon-share`;

    const span = document.createElement('span');
    span.className = 'soc-list__share-title';
    span.textContent = title;

    item.appendChild(icon);
    item.appendChild(span);
    li.appendChild(item);


    //поменял

    // Обработчик соцсетей — с AJAX
    // item.addEventListener('click', (ev) => {
    //   ev.stopPropagation();
    //
    //   // 1. Отправляем AJAX
    //   let data_id = wrapper.dataset.id || '0';
    //   let data_el_type = wrapper.dataset.elType || defaultType;
    //   let element_count = wrapper.querySelector('.js-likes-share');
    //   if (element_count) {
    //     const count = parseInt(element_count.textContent) || 0;
    //     shareAjax(data_id, data_el_type, element_count, count);
    //   }
    //
    //   // 2. Открываем шеринг
    //   const shareUrl = getShareUrl(service, { rawUrl, rawText, rawImage });
    //   window.open(shareUrl, '_blank', 'width=600,height=500,scrollbars=yes,resizable=yes');
    //
    //   // 3. Закрываем popup
    //   hideDropdown(dropdown);
    // });

    item.addEventListener('click', (ev) => {
      ev.stopPropagation();

      //  Отправляем AJAX
      let data_id = wrapper.dataset.id || '0';
      let data_el_type = wrapper.dataset.elType || defaultType;
      let element_count = wrapper.querySelector('.js-likes-share');
      if (element_count) {
        const count = parseInt(element_count.textContent) || 0;
        shareAjax(data_id, data_el_type, element_count, count);
      }

      const shareUrl = getShareUrl(service, { rawUrl, rawText, rawImage });

      //  Определяем: мобильное устройство?
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      if (isMobile) {
        //  Мобилка: открываем в текущей вкладке (без popup’ов, без about:blank)
        location.href = shareUrl;
        // Закрываем popup после короткой задержки (чтобы AJAX ушёл)
        setTimeout(() => hideDropdown(dropdown), 100);
      } else {
        //  Десктоп: popup как раньше
        const popup = window.open('', '_blank', 'width=600,height=500,scrollbars=yes,resizable=yes');
        if (popup) {
          popup.location.href = shareUrl;
        } else {
          // Если popup заблокирован — fallback в текущей вкладке
          location.href = shareUrl;
        }
        hideDropdown(dropdown);
      }
    });

    ul.appendChild(li);
  });

  // === Кнопка "Другие" ===
  const isMobileOrTablet = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  if (navigator.share && isMobileOrTablet) {
    const otherLi = document.createElement('li');
    const otherDiv = document.createElement('div');
    otherDiv.className = 'soc-list__share-item soc-list__share-other';

    const otherIcon = document.createElement('div');
    otherIcon.className = 'soc-list__share-icon other-icon-share';

    const otherTitle = document.createElement('span');
    otherTitle.className = 'soc-list__share-title';
    otherTitle.textContent = 'Другие';

    otherDiv.appendChild(otherIcon);
    otherDiv.appendChild(otherTitle);
    otherLi.appendChild(otherDiv);
    ul.appendChild(otherLi);

    otherDiv.addEventListener('click', (ev) => {
      ev.stopPropagation();
      navigator.share({
        title: rawText || document.title,
        text: rawText || '',
        url: rawUrl || location.href
      })
        .then(() => {
          // Успешно поделились → AJAX + закрытие
          let data_id = wrapper.dataset.id || '0';
          let data_el_type = wrapper.dataset.elType || defaultType;
          let element_count = wrapper.querySelector('.js-likes-share');
          if (element_count) {
            const count = parseInt(element_count.textContent) || 0;
            shareAjax(data_id, data_el_type, element_count, count);
          }
          hideDropdown(dropdown);
        })
        .catch(err => {
          if (err.name !== 'AbortError') {
            console.warn('Web Share failed:', err);
          }
        });
    });
  }

  // Копирование
  const copyLi = document.createElement('li');
  const copyDiv = document.createElement('div');
  copyDiv.className = 'soc-list__copy-link';

  const copyIcon = document.createElement('div');
  copyIcon.className = 'soc-list__share-icon copy-link';

  const copyTitle = document.createElement('span');
  copyTitle.className = 'soc-list__share-title';
  copyTitle.textContent = 'Скопировать ссылку';

  copyDiv.appendChild(copyIcon);
  copyDiv.appendChild(copyTitle);
  copyLi.appendChild(copyDiv);
  ul.appendChild(copyLi);

  dropdown.appendChild(ul);

  // Обработчик копирования — с AJAX
  copyDiv.addEventListener('click', function (ev) {
    ev.stopPropagation();
    const copy = () => {
      if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
        return navigator.clipboard.writeText(rawUrl);
      } else {
        const textarea = document.createElement('textarea');
        textarea.value = rawUrl;
        textarea.setAttribute('readonly', '');
        textarea.style.position = 'absolute';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.select();
        const ok = document.execCommand('copy');
        document.body.removeChild(textarea);
        return ok ? Promise.resolve() : Promise.reject(new Error('copy failed'));
      }
    };

    copy()
      .then(() => {
        // AJAX при успешном копировании
        let data_id = wrapper.dataset.id || '0';
        let data_el_type = wrapper.dataset.elType || defaultType;
        let element_count = wrapper.querySelector('.js-likes-share');
        if (element_count) {
          const count = parseInt(element_count.textContent) || 0;
          shareAjax(data_id, data_el_type, element_count, count);
        }

        copyTitle.textContent = 'Скопировано';
        setTimeout(() => {
          if (activeDropdown === dropdown) {
            hideDropdown(dropdown);
          }
        }, 500);
      })
      .catch(err => {
        console.warn('Не удалось скопировать:', err);
        copyTitle.textContent = 'Ошибка';
        setTimeout(() => {
          if (copyTitle.textContent === 'Ошибка') {
            copyTitle.textContent = 'Скопировать ссылку';
          }
        }, 1500);
      });
  });

  // Закрытие по клику вне (без изменений)
  const onClickOutside = (ev) => {
    if (!activeDropdown || activeDropdown !== dropdown) return;
    const clickedInside = dropdown.contains(ev.target) || ev.target.closest('.js--soc-list-share');
    if (clickedInside) return;
    hideDropdown(dropdown);
    const clickedOnLink = ev.target.closest('a[href]');
    if (clickedOnLink) {
      ev.stopPropagation();
      ev.preventDefault();
    }
  };
  document.addEventListener('click', onClickOutside);
  dropdown._cleanup = () => document.removeEventListener('click', onClickOutside);

  // Измерение ширины (без изменений)
  setTimeout(() => {
    const temp = document.createElement('div');
    Object.assign(temp.style, {
      position: 'absolute',
      visibility: 'hidden',
      pointerEvents: 'none',
      width: 'max-content',
      opacity: '0',
    });
    temp.innerHTML = dropdown.innerHTML;
    document.body.appendChild(temp);
    const width = temp.getBoundingClientRect().width;
    dropdown.dataset.popupWidth = width;
    document.body.removeChild(temp);
  }, 0);

  return dropdown;
}

// Генерация share-ссылок
function getShareUrl(service, { rawUrl, rawText, rawImage }) {
  const url = encodeURIComponent(rawUrl);
  const text = encodeURIComponent(rawText);
  const image = encodeURIComponent(rawImage);

  switch (service) {
    case 'whatsapp':
      return `https://api.whatsapp.com/send?text=${text} ${url}&utm_source=share2`;
    case 'telegram':
      return `https://t.me/share/url?url=${url}&text=${text}&utm_source=share2`;
    case 'vkontakte':
      return `https://vk.com/share.php?url=${url}&title=${text}&image=${image}&noparse=true&utm_source=share2`;
    case 'max':
      return `https://max.ru/:share?text=${url}&utm_source=share2`;
    case 'odnoklassniki':
      return `https://connect.ok.ru/offer?url=${url}&title=${text}&imageUrl=${image}&utm_source=share2`;
    default:
      return '#';
  }
}

document.addEventListener('click', function (e) {
  const trigger = e.target.closest('.js--soc-list-share');
  if (trigger) {
    handleShareClick(trigger, e);
  }
}, true);


