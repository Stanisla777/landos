/* eslint-disable */
export default function contentNote() {
  const notes = document.querySelectorAll('.js--content-note');
  let activeTooltip = null;
  let isFirstTouch = true;

  // Упрощенная проверка на touch-устройство
  const isTouchDevice = () => {
    return 'ontouchstart' in window || 
           navigator.maxTouchPoints > 0 || 
           navigator.msMaxTouchPoints > 0;
  };

  // Функция для скрытия всех тултипов
  const hideAllTooltips = () => {
    notes.forEach(item => {
      item.classList.remove('active');
      const tooltip = item.querySelector('.content-note__text');
      if (tooltip) {
        tooltip.classList.remove('active');
      }
    });
    activeTooltip = null;
  };

  // Функция для позиционирования тултипа
  const positionTooltip = (element) => {
    const rect = element.getBoundingClientRect();
    const parent = element.parentElement;
    const tooltip = element.querySelector('.content-note__text');
    const noteText = element.querySelector('.content-note__text');
    const windowWidth = window.innerWidth;
    const windowHeight = window.innerHeight;
    
    if (!tooltip) return;

    // Позиционирование по горизонтали
    if (element.closest('.js--courses-accord-content') || element.closest('.js--element-overflow')) {
      const parentPos = parent.getBoundingClientRect();
      const relativePosLeftElement = rect.left - parentPos.left;
      const parentWidth = parent.offsetWidth;

      if (windowWidth >= 600) {
        if (parentWidth / 2 < relativePosLeftElement) {
          noteText.style.left = 'auto';
          noteText.style.right = '-0.25rem';
        } else {
          noteText.style.left = '0.25rem';
          noteText.style.right = 'auto';
        }
      }
    } else {
      const centerX = rect.left + rect.width / 2;
      
      if (windowWidth >= 600) {
        if (windowWidth / 2 < centerX) {
          noteText.style.left = 'auto';
          noteText.style.right = '-0.25rem';
        } else {
          noteText.style.left = '0.25rem';
          noteText.style.right = 'auto';
        }
      }
    }

    // Позиционирование по вертикали
    const centerY = rect.top + rect.height / 2;
    
    if (windowHeight / 2 > centerY) {
      noteText.style.top = 'calc(100% + 0.25rem)';
      noteText.style.bottom = 'auto';
    } else {
      noteText.style.top = 'auto';
      noteText.style.bottom = 'calc(100% + 0.25rem)';
    }

    // Мобильная адаптация
    if (windowWidth < 600) {
      noteText.style.inset = 'unset';
      const tooltipWidth = tooltip.offsetWidth;
      const translateX = -((rect.left - tooltipWidth / 2 + 7) - (windowWidth / 2 - tooltipWidth / 2));
      noteText.style.transform = `translateX(${translateX}px)`;
    }
  };

  // Обработчик для touch устройств
  if (isTouchDevice()) {
    // Обработка кликов по документу
    document.addEventListener('touchstart', (e) => {
      const isTooltip = e.target.closest('.js--content-note');
      const isTooltipContent = e.target.closest('.content-note__text');
      
      // Если клик вне тултипа - скрываем все
      if (!isTooltip && !isTooltipContent) {
        hideAllTooltips();
        return;
      }

      // Если клик по самому тултипу
      if (isTooltip && !isTooltipContent) {
        const tooltipElement = e.target.closest('.js--content-note');
        
        // Если это активный тултип - скрываем
        if (tooltipElement.classList.contains('active')) {
          hideAllTooltips();
          return;
        }

        // Скрываем другие тултипы и показываем текущий
        hideAllTooltips();
        
        setTimeout(() => {
          tooltipElement.classList.add('active');
          const tooltipText = tooltipElement.querySelector('.content-note__text');
          if (tooltipText) {
            tooltipText.classList.add('active');
            positionTooltip(tooltipElement);
          }
          activeTooltip = tooltipElement;
        }, 100);
      }
    });

    // Дополнительная защита от случайных кликов
    document.addEventListener('click', (e) => {
      const isTooltip = e.target.closest('.js--content-note');
      const isTooltipContent = e.target.closest('.content-note__text');
      
      if (!isTooltip && !isTooltipContent) {
        hideAllTooltips();
      }
    });
  }

  // Обработчики для desktop
  document.addEventListener('mouseover', (e) => {
    if (e.target.classList.contains('js--content-note')) {
      const tooltipElement = e.target;
      tooltipElement.classList.add('active');
      
      const tooltipText = tooltipElement.querySelector('.content-note__text');
      if (tooltipText) {
        tooltipText.classList.add('active');
        positionTooltip(tooltipElement);
      }
    }
  });

  document.addEventListener('mouseout', (e) => {
    if (e.target.classList.contains('js--content-note')) {
      const tooltipElement = e.target;
      tooltipElement.classList.remove('active');
      
      const tooltipText = tooltipElement.querySelector('.content-note__text');
      if (tooltipText) {
        tooltipText.classList.remove('active');
      }
    }
  });

  // Закрытие по ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      hideAllTooltips();
    }
  });
}
