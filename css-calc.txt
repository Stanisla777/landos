// modules/copy-citation.js

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML; // экранирует <, >, &, " и т.д.
}

document.addEventListener('copy', (event) => {
  const activeEl = document.activeElement;
  if (
    activeEl &&
    (activeEl.tagName === 'INPUT' ||
     activeEl.tagName === 'TEXTAREA' ||
     activeEl.contentEditable === 'true')
  ) {
    return;
  }

  const selection = window.getSelection();
  if (!selection || selection.toString().trim() === '') return;

  const selectedText = selection.toString();
  if (selectedText.length <= 20) return;

  const pageUrl = new URL(window.location.href);
  pageUrl.searchParams.set('utm_source', 'copy_text');
  pageUrl.searchParams.set('utm_medium', 'sharing');
  pageUrl.searchParams.set('utm_campaign', 'citation');

  const citationText = 'Подробнее на сайте ПАО ДОМ.РФ: ' + pageUrl.toString();

  // Plain text — для Блокнота, терминала и т.д.
  const plain = selectedText + '\n\n' + citationText;

  // HTML — для Word, Gmail, Outlook и других rich-редакторов
  const html = `
    ${escapeHtml(selectedText).replace(/\n/g, '<br>')}
    <br><br>
    Подробнее на сайте ПАО ДОМ.РФ: <a href="${pageUrl}">${pageUrl}</a>
  `.trim();

  event.clipboardData.setData('text/plain', plain);
  event.clipboardData.setData('text/html', html);
  event.preventDefault();
});
