Демо-страницы с видео:
https://rssprosi-3100.sprosi.dev.ringsites.ahml.ru/education/video/testovoe-video-ot-vkvideo-ru/
https://rssprosi-3100.sprosi.dev.ringsites.ahml.ru/education/video/testovoe-video-ot-rutube-ru/

Видео с локальными файлами:

https://rssprosi-3100.sprosi.dev.ringsites.ahml.ru/education/video/sberezhenie-sredstv-v-krizisnoy-situatsii/

https://rssprosi-3100.sprosi.dev.ringsites.ahml.ru/education/video/keshbek-dlya-zhizni-kak-vernut-potrachennye-dengi/



document.addEventListener('DOMContentLoaded', initShareBlocks);

/**
 * Инициализация всех кнопок "Поделиться"
 */
function initShareBlocks() {
  const triggers = document.querySelectorAll('.js--soc-list-share:not([data-initialized])');
  triggers.forEach(trigger => {
    trigger.dataset.initialized = 'true';
    trigger.addEventListener('click', handleShareClick);
  });
}

/**
 * Обработчик клика по кнопке "Поделиться"
 */
function handleShareClick(e) {
  e.preventDefault();
  const trigger = e.currentTarget;
  const wrapper = trigger.closest('.js--soc-list-wrapper-share');
  if (!wrapper) return;

  let dropdown = wrapper.querySelector('.soc-list__share');
  if (!dropdown) {
    dropdown = createShareDropdown(wrapper);
    wrapper.appendChild(dropdown);
  }

  // Позиционируем и показываем
  positionDropdown(trigger, dropdown);
  dropdown.style.display = 'block';
}

/**
 * Позиционирование dropdown под кнопкой
 */
function positionDropdown(trigger, dropdown) {
  const rect = trigger.getBoundingClientRect();
  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;

  const top = rect.top + rect.height + scrollTop;
  const left = rect.left + scrollLeft;

  dropdown.style.top = `${top}px`;
  dropdown.style.left = `${left}px`;
}

/**
 * Создаёт dropdown "Поделиться"
 */
function createShareDropdown(wrapper) {
  // === 1. Парсинг data-services (поддержка всех форматов) ===
  const servicesStr = (wrapper.dataset.services || '').trim();
  let services = [];

  if (servicesStr) {
    try {
      // 1. JSON: ["a","b"]
      services = JSON.parse(servicesStr);
    } catch {
      try {
        // 2. [a,b]
        const cleaned = servicesStr
          .replace(/^\[/, '')
          .replace(/\]$/, '')
          .trim();
        if (cleaned) {
          services = cleaned.split(',').map(s => s.trim()).filter(Boolean);
        }
      } catch {
        // 3. a,b
        services = servicesStr.split(',').map(s => s.trim()).filter(Boolean);
      }
    }
  }

  if (!Array.isArray(services)) services = [];

  // === 2. Данные для шаринга ===
  const rawUrl = wrapper.dataset.url || location.href;
  const rawText = wrapper.dataset.text || document.title;
  const rawImage = wrapper.dataset.image || '';

  const url = encodeURIComponent(rawUrl);
  const text = encodeURIComponent(rawText);
  const imageUrl = encodeURIComponent(rawImage);

  // === 3. Создание DOM ===
  const dropdown = document.createElement('div');
  dropdown.className = 'soc-list__share';
  dropdown.style.display = 'none';

  const ul = document.createElement('ul');

  const serviceTitles = {
    whatsapp: 'WhatsApp',
    telegram: 'Telegram',
    vkontakte: 'ВКонтакте',
    odnoklassniki: 'Одноклассники',
  };

  // Сервисы
  services.forEach(service => {
    const title = serviceTitles[service];
    if (!title) return;

    const li = document.createElement('li');
    const a = document.createElement('a');
    const icon = document.createElement('div');
    const span = document.createElement('span');

    icon.className = `soc-list__share-icon ${service}`;
    span.className = 'soc-list__share-title';
    span.textContent = title;

    a.href = getShareUrl(service, { url, text, imageUrl });
    a.target = '_blank';
    a.rel = 'noopener noreferrer';
    a.appendChild(icon);
    a.appendChild(span);

    li.appendChild(a);
    ul.appendChild(li);
  });

  // === 4. Копирование ссылки ===
  const copyLi = document.createElement('li');
  const copyDiv = document.createElement('div');
  copyDiv.dataset.copyLink = '';

  const copyIcon = document.createElement('div');
  copyIcon.className = 'soc-list__share-icon copy-link';

  const copyTitle = document.createElement('span');
  copyTitle.className = 'soc-list__share-title';
  copyTitle.textContent = 'Скопировать ссылку';

  copyDiv.appendChild(copyIcon);
  copyDiv.appendChild(copyTitle);
  copyLi.appendChild(copyDiv);
  ul.appendChild(copyLi);

  dropdown.appendChild(ul);

  // === 5. Обработчик копирования (с обратной связью) ===
  copyDiv.addEventListener('click', function (ev) {
    ev.stopPropagation();
    const titleEl = copyTitle;
    if (!titleEl) return;

    const originalText = 'Скопировать ссылку';
    const successText = 'Скопировано';

    // Очистка предыдущего таймера
    if (copyDiv.dataset.timeoutId) {
      clearTimeout(parseInt(copyDiv.dataset.timeoutId, 10));
      delete copyDiv.dataset.timeoutId;
    }

    // Функция копирования
    const copy = () => {
      if (navigator.clipboard?.writeText) {
        return navigator.clipboard.writeText(rawUrl);
      } else {
        const textarea = document.createElement('textarea');
        textarea.value = rawUrl;
        textarea.setAttribute('readonly', '');
        textarea.style.position = 'absolute';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.select();
        const ok = document.execCommand('copy');
        document.body.removeChild(textarea);
        return ok ? Promise.resolve() : Promise.reject(new Error('copy failed'));
      }
    };

    copy()
      .then(() => {
        titleEl.textContent = successText;

        const tid = setTimeout(() => {
          titleEl.textContent = originalText;
          delete copyDiv.dataset.timeoutId;
        }, 3000);
        copyDiv.dataset.timeoutId = String(tid);
      })
      .catch(err => {
        console.warn('Не удалось скопировать ссылку:', err);
        // При ошибке — не меняем текст (или можно на 1.5с поставить "Ошибка", если нужно)
      });
  });

  // === 6. Закрытие по клику на любой пункт ===
  dropdown.addEventListener('click', (ev) => {
    const clickedOnItem = ev.target.closest('a, div[data-copy-link]');
    if (clickedOnItem && !clickedOnItem.closest('.soc-list__share-icon.copy-link')) {
      // Закрываем, кроме копирования (оно уже обрабатывается отдельно)
      dropdown.style.display = 'none';
    }
  });

  // === 7. Закрытие по клику вне dropdown ===
  document.addEventListener('click', function closeOnClickOutside(ev) {
    if (
      dropdown.style.display === 'block' &&
      !dropdown.contains(ev.target) &&
      !triggerContainsAnyShareButton(ev.target)
    ) {
      dropdown.style.display = 'none';
    }
  });

  return dropdown;
}

/**
 * Вспомогательная: есть ли в цепочке target кнопка share?
 */
function triggerContainsAnyShareButton(target) {
  const triggers = document.querySelectorAll('.js--soc-list-share');
  return Array.from(triggers).some(t => t.contains(target) || t === target);
}

/**
 * Генерация share-ссылки
 */
function getShareUrl(service, { url, text, imageUrl }) {
  switch (service) {
    case 'whatsapp':
      return `https://wa.me/?text=${text}%20${url}`;
    case 'telegram':
      return `https://t.me/share/url?url=${url}&text=${text}`;
    case 'vkontakte':
      return `https://vk.com/share.php?url=${url}&title=${text}&image=${imageUrl}&noparse=true`;
    case 'odnoklassniki':
      return `https://connect.ok.ru/offer?url=${url}&title=${text}&imageUrl=${imageUrl}`;
    default:
      return '#';
  }
}


