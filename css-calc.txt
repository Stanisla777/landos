// content-note-new.js
/* eslint-disable */

// Глобальные переменные
let activeTooltip = null;
let activeTrigger = null;
let tooltipContainer = null;
let isBodyLocked = false;

// Создаём общий контейнер один раз
function ensureTooltipContainer() {
  if (!tooltipContainer) {
    tooltipContainer = document.createElement('div');
    tooltipContainer.className = 'tooltip-popup-container';
    Object.assign(tooltipContainer.style, {
      position: 'fixed',
      top: '0',
      left: '0',
      width: '100%',
      height: '100%',
      pointerEvents: 'none',
      zIndex: '2147483646',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
    });
    document.body.appendChild(tooltipContainer);
  }
  return tooltipContainer;
}

// Функции блокировки/разблокировки скролла
function addClassBody() {
  if (isBodyLocked) return;
  isBodyLocked = true;
  document.body.classList.add('body-modal', 'body-additional-class');
}

function removeClassBody() {
  if (!document.body.classList.contains('body-modal-modals')) {
    document.body.classList.remove('body-modal', 'body-additional-class');
  }
  isBodyLocked = false;
}

// Определение мобильного/планшетного устройства
function isMobileDevice() {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

function isMobilePhone() {
  const ua = navigator.userAgent;
  if (/iPhone/.test(ua) && !/iPad/.test(ua)) return true;
  if (/Android/.test(ua) && /Mobile/.test(ua)) return true;
  return false;
}

// Создание тултипа
function createTooltip(content) {
  const tooltip = document.createElement('div');
  tooltip.className = 'content-note__text-new';
  tooltip.style.cssText = `
    opacity: 0;
    pointerEvents: none;
    transition: opacity 0.2s ease, transform 0.2s ease;
  `;
  
  // Проверяем, содержит ли контент HTML
  const hasHTML = /<[^>]+>/.test(content);
  const textLength = content.replace(/<[^>]+>/g, '').length;
  
  // Определяем тип позиционирования
  if (!hasHTML && textLength <= 40) {
    tooltip.classList.add('location-side');
  }
  
  // Добавляем контент
  tooltip.innerHTML = content;
  
  return tooltip;
}

// Позиционирование тултипа относительно триггера
function positionTooltip(trigger, tooltip) {
  const rect = trigger.getBoundingClientRect();
  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;
  
  const isMobileOrTablet = isMobileDevice();
  const isNarrow = window.matchMedia('(max-width: 480px)').matches;
  
  // Для мобильных устройств используем мобильный вид
  if (isMobileOrTablet || isNarrow) {
    tooltip.style.transform = 'translate(-50%, -50%)';
    tooltip.classList.add('mobile-tooltip');
    return;
  }
  
  // Сбрасываем позиционирование
  tooltip.style.left = '';
  tooltip.style.right = '';
  tooltip.style.top = '';
  tooltip.style.bottom = '';
  tooltip.style.transform = '';
  
  // Измеряем размеры тултипа
  const originalDisplay = tooltip.style.display;
  tooltip.style.display = 'block';
  tooltip.style.opacity = '0';
  const tooltipRect = tooltip.getBoundingClientRect();
  const tooltipWidth = tooltipRect.width;
  const tooltipHeight = tooltipRect.height;
  tooltip.style.display = originalDisplay;
  tooltip.style.opacity = '';
  
  // Определяем позиционирование для короткого текста
  if (tooltip.classList.contains('location-side')) {
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    
    // Горизонтальное позиционирование
    if (centerX + tooltipWidth + 20 > viewportWidth) {
      tooltip.style.right = `${viewportWidth - centerX + rect.width / 2 + 10}px`;
      tooltip.classList.add('left');
      tooltip.classList.remove('right');
    } else {
      tooltip.style.left = `${centerX + rect.width / 2 + 10}px`;
      tooltip.classList.add('right');
      tooltip.classList.remove('left');
    }
    
    // Вертикальное позиционирование (по центру)
    tooltip.style.top = `${centerY - tooltipHeight / 2}px`;
    tooltip.classList.remove('up', 'down');
    
    return;
  }
  
  // Для длинного текста используем стандартное позиционирование
  
  // Горизонтальное позиционирование
  const centerX = rect.left + rect.width / 2;
  if (centerX + tooltipWidth / 2 > viewportWidth - 20) {
    tooltip.style.right = `${viewportWidth - centerX - rect.width / 2 + 10}px`;
    tooltip.classList.add('left');
    tooltip.classList.remove('right');
  } else if (centerX - tooltipWidth / 2 < 20) {
    tooltip.style.left = `${centerX - rect.width / 2 - 10}px`;
    tooltip.classList.add('right');
    tooltip.classList.remove('left');
  } else {
    tooltip.style.left = `${centerX - tooltipWidth / 2}px`;
  }
  
  // Вертикальное позиционирование
  const centerY = rect.top + rect.height / 2;
  if (centerY + tooltipHeight + 20 > viewportHeight) {
    tooltip.style.bottom = `${viewportHeight - centerY + rect.height / 2 + 10}px`;
    tooltip.classList.add('up');
    tooltip.classList.remove('down');
  } else {
    tooltip.style.top = `${centerY + rect.height / 2 + 10}px`;
    tooltip.classList.add('down');
    tooltip.classList.remove('up');
  }
}

// Показ тултипа
function showTooltip(trigger, content) {
  // Закрываем предыдущий тултип, если он есть
  if (activeTooltip) {
    hideTooltip(activeTooltip);
  }
  
  // === КЛЮЧЕВОЙ МОМЕНТ: Создаем новый тултип именно с контентом из data-content-text текущего триггера ===
  const tooltip = createTooltip(content);
  ensureTooltipContainer().appendChild(tooltip);
  
  // === Позиционируем тултип относительно именно этого триггера ===
  positionTooltip(trigger, tooltip);
  
  // Показываем с анимацией
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      tooltip.style.opacity = '1';
      tooltip.style.pointerEvents = 'auto';
      tooltip.classList.add('active');
    });
  });
  
  // === Сохраняем ссылки на текущий тултип и его триггер ===
  activeTooltip = tooltip;
  activeTrigger = trigger;
  
  // Для мобильных добавляем блокировку скролла
  if (isMobileDevice()) {
    addClassBody();
  }
}

// Скрытие тултипа
function hideTooltip(tooltip) {
  if (!tooltip) return;
  
  tooltip.style.pointerEvents = 'none';
  tooltip.style.opacity = '0';
  tooltip.classList.remove('active');
  
  setTimeout(() => {
    if (tooltip.parentNode) {
      tooltip.parentNode.removeChild(tooltip);
    }
    
    // Разблокируем скролл для мобильных
    if (isMobileDevice()) {
      removeClassBody();
    }
  }, 200);
  
  activeTooltip = null;
  activeTrigger = null;
}

// === ОБРАБОТЧИК НАВЕДЕНИЯ ===
function handleMouseOver(e) {
  // Находим именно тот элемент, на который навели
  const trigger = e.target.closest('.js--content-note-new');
  if (!trigger) return;
  
  // === Читаем контент именно из этого элемента ===
  const content = trigger.dataset.contentText || '';
  if (!content) return;
  
  // Если уже открыт тултип для этого же триггера - ничего не делаем
  if (activeTooltip && activeTrigger === trigger) {
    return;
  }
  
  // === Показываем тултип с контентом из именно этого триггера ===
  showTooltip(trigger, content);
}

// === ОБРАБОТЧИК УХОДА МЫШИ ===
function handleMouseOut(e) {
  const trigger = e.target.closest('.js--content-note-new');
  const relatedTarget = e.relatedTarget || e.toElement;
  
  // Проверяем, ушли ли мы на сам тултип
  const isTooltip = relatedTarget && relatedTarget.closest && relatedTarget.closest('.content-note__text-new');
  
  if (trigger && !isTooltip) {
    // Задержка перед скрытием для плавности
    setTimeout(() => {
      if (activeTooltip && activeTrigger === trigger) {
        hideTooltip(activeTooltip);
      }
    }, 150);
  }
}

// === ОБРАБОТЧИК КЛИКА ДЛЯ МОБИЛЬНЫХ ===
function handleClick(e) {
  const trigger = e.target.closest('.js--content-note-new');
  if (!trigger) return;
  
  // === Читаем контент именно из этого элемента ===
  const content = trigger.dataset.contentText || '';
  if (!content) return;
  
  // Предотвращаем стандартное поведение
  e.preventDefault();
  
  // Если тултип уже открыт для этого же триггера - закрываем
  if (activeTooltip && activeTrigger === trigger) {
    hideTooltip(activeTooltip);
    return;
  }
  
  // === Показываем тултип с контентом из именно этого триггера ===
  showTooltip(trigger, content);
}

// Обработчик клика вне тултипа
function handleClickOutside(e) {
  if (!activeTooltip) return;
  
  const clickedInside = activeTooltip.contains(e.target) || 
                       (activeTrigger && activeTrigger.contains(e.target));
  
  if (!clickedInside) {
    hideTooltip(activeTooltip);
  }
}

// Обработчик изменения размера окна
function handleResize() {
  if (activeTooltip && activeTrigger) {
    positionTooltip(activeTrigger, activeTooltip);
  }
  
  // Для мобильных устройств закрываем тултип при изменении ориентации
  const isMobileOrTablet = isMobileDevice();
  const isNarrow = window.matchMedia('(max-width: 480px)').matches;
  
  if (isMobileOrTablet && !isNarrow && activeTooltip) {
    hideTooltip(activeTooltip);
  }
}

// Инициализация
export default function contentNoteNew() {
  // Добавляем обработчики событий
  document.addEventListener('mouseover', handleMouseOver);
  document.addEventListener('mouseout', handleMouseOut);
  document.addEventListener('click', handleClickOutside);
  window.addEventListener('resize', handleResize);
  
  // Для мобильных устройств используем клик вместо наведения
  const isIOS = (/(iPad|iPhone|iPod)/.test(navigator.userAgent) && !window.MSStream) ||
                (navigator.userAgent.includes('Mac') && 'ontouchend' in document);
  
  if (isIOS || isMobileDevice()) {
    document.addEventListener('touchstart', handleClick, { passive: false });
  }
  
  // Обработчик для закрытия по клику на крестики в мобильном тултипе
  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('js--close-mobile-tooltip') && activeTooltip) {
      hideTooltip(activeTooltip);
    }
  });
}


----------------------------------------------------------------------------------------------

// content-note-new.scss

.tooltip-popup-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 2147483646;
  display: flex;
  align-items: center;
  justify-content: center;
}

.content-note__text-new {
  position: absolute;
  background: #fff;
  border-radius: 8px;
  padding: 16px 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  max-width: 320px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease, transform 0.2s ease;
  font-size: 14px;
  line-height: 1.4;
  color: #333;
  
  &.active {
    opacity: 1;
    pointer-events: auto;
  }
  
  // Позиционирование для короткого текста
  &.location-side {
    max-width: 280px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    
    &.left {
      transform: translateX(-100%);
    }
    
    &.right {
      transform: translateX(0);
    }
  }
  
  // Стрелка для тултипа
  &::before {
    content: '';
    position: absolute;
    width: 0;
    height: 0;
    border-style: solid;
    border-color: transparent;
    border-width: 6px;
    z-index: 1;
  }
  
  // Стрелка для разных позиций
  &.down::before {
    top: -12px;
    left: 50%;
    transform: translateX(-50%);
    border-bottom-color: #fff;
  }
  
  &.up::before {
    bottom: -12px;
    left: 50%;
    transform: translateX(-50%);
    border-top-color: #fff;
  }
  
  &.left::before {
    right: -12px;
    top: 50%;
    transform: translateY(-50%);
    border-left-color: #fff;
  }
  
  &.right::before {
    left: -12px;
    top: 50%;
    transform: translateY(-50%);
    border-right-color: #fff;
  }
  
  // Мобильный вид
  &.mobile-tooltip {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: calc(100% - 32px);
    max-width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    border-radius: 16px;
    padding: 24px;
    
    // Мобильный хедер
    &::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 44px;
      background: #fff;
      border-radius: 16px 16px 0 0;
      z-index: 10;
    }
    
    // Кнопка закрытия
    &::after {
      content: '×';
      position: absolute;
      top: 12px;
      right: 16px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: #666;
      cursor: pointer;
      z-index: 11;
      transition: color 0.2s ease;
      
      &:hover {
        color: #333;
      }
    }
  }
}

// Иконка для тултипа
.js--content-note-new {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #f0f0f0;
  color: #666;
  font-size: 12px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s ease;
  user-select: none;
  
  &:hover {
    background: #e0e0e0;
    color: #333;
  }
  
  // Стили для разных тем
  &.white {
    background: #fff;
    color: #999;
    border: 1px solid #e0e0e0;
    
    &:hover {
      background: #f5f5f5;
      color: #666;
    }
  }
}
